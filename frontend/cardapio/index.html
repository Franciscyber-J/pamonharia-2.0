<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio - Pamonharia Sabor do Goiás</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos para os ícones de pagamento */
        .payment-icons {
            display: inline-flex;
            gap: 6px;
            vertical-align: middle;
            margin-left: 8px;
        }
        .payment-icons svg {
            width: 28px;
            height: auto;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- O cabeçalho e o resto da estrutura permanecem os mesmos -->
        <header class="header">
            <div class="header-center">
                <h1 id="store-name-header">Pamonharia Sabor do Goiás</h1>
                <p>O verdadeiro sabor da fazenda, direto para a sua mesa!</p>
            </div>
            <button id="theme-switcher" class="theme-switcher" title="Alterar tema">
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
        </header>

        <div id="store-status-banner"></div>

        <div class="content-wrapper">
            <main>
                <div id="combos-section" style="display: none;">
                    <h2 class="section-title">Nossos Combos</h2>
                    <div id="combos-grid" class="items-grid"></div>
                </div>
                <hr id="section-divider" style="margin: 40px 0; border: 1px solid var(--border-color); display: none;">
                <div id="products-section" style="display: none;">
                    <h2 class="section-title">Produtos Individuais</h2>
                    <div id="products-grid" class="items-grid"></div>
                </div>
            </main>
            <aside>
                <div id="cart-wrapper" class="cart-container">
                    <div class="cart-header">
                        <h2>Meu Carrinho</h2>
                        <button id="clear-cart-btn" style="display: none;">Limpar</button>
                    </div>
                    <div id="cart-items">
                        <p id="empty-cart-msg">Seu carrinho está vazio.</p>
                    </div>
                    <div class="cart-totals">
                        <div class="total-row"><span>Subtotal</span><span id="subtotal">R$ 0,00</span></div>
                        <div class="total-row" id="delivery-fee-row"><span>Taxa de Entrega</span><span id="delivery-fee">R$ 0,00</span></div>
                        <div class="total-row grand-total"><span>Total</span><span id="grand-total">R$ 0,00</span></div>
                    </div>
                    <div class="checkout-form">
                        <h3>Finalizar Pedido</h3>
                        <form id="order-form">
                            <div class="form-group">
                                <label for="client-name">Nome</label>
                                <input type="text" id="client-name" required>
                            </div>
                            <div class="form-group">
                                <label for="client-phone">Contacto (WhatsApp)</label>
                                <input type="tel" id="client-phone" required>
                            </div>
                            
                            <div class="delivery-options">
                                <label><input type="radio" name="delivery-type" value="delivery" checked> Entrega</label>
                                <label><input type="radio" name="delivery-type" value="pickup"> Retirada</label>
                            </div>

                            <div class="form-group" id="address-group">
                                <label for="client-address">Endereço de Entrega</label>
                                <input type="text" id="client-address" required>
                            </div>

                            <div class="payment-options">
                                <p>Forma de Pagamento:</p>
                                <label><input type="radio" name="payment-method" value="on_delivery" checked> Pagar na Entrega/Retirada</label>
                                <label>
                                    <input type="radio" name="payment-method" value="online"> Pagar Online
                                    <span class="payment-icons">
                                        <!-- Ícone do Pix -->
                                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.0002 2.66602L15.3335 5.99935L12.0002 9.33268L8.66683 5.99935L12.0002 2.66602Z" fill="#32BCAD"></path><path d="M5.99984 8.66602L2.6665 11.9993L5.99984 15.3327L9.33317 11.9993L5.99984 8.66602Z" fill="#32BCAD"></path><path d="M18.0002 8.66602L14.6668 11.9993L18.0002 15.3327L21.3335 11.9993L18.0002 8.66602Z" fill="#32BCAD"></path><path d="M12.0002 14.666L15.3335 17.9994L12.0002 21.3327L8.66683 17.9994L12.0002 14.666Z" fill="#32BCAD"></path></svg>
                                        <!-- Ícone da Visa -->
                                        <svg viewBox="0 0 38 24" xmlns="http://www.w3.org/2000/svg"><path d="M35 0H3C1.3 0 0 1.3 0 3v18c0 1.7 1.4 3 3 3h32c1.7 0 3-1.3 3-3V3c0-1.7-1.4-3-3-3z" fill="#1A1F71"/><path d="M15.2 14.5l-2.3-8.8H9.4l-1.3 6.2c-.3-1.2-1.3-3.1-2.2-4.1-.9-1-2.1-1.8-3.1-2.1L2.6 14.5h3.2l.9-4.1c.2-.9.4-1.7.5-2.1.2.9.4 1.7.6 2.5l.6 3.7h3.1zM28.9 5.7c-1.3 0-2.4.6-2.9 1.5-.5-.8-1.5-1.5-2.8-1.5-1.5 0-2.7 1-2.7 2.5 0 1.3.8 2 1.4 2.4.6.4 1.1.7 1.1.9 0 .3-.3.5-.8.5-.7 0-1.1-.2-1.6-.5l-.3-.1-.3 2.5c.5.2 1.3.4 2.1.4 1.6 0 2.8-1 2.8-2.6 0-1.1-.7-1.8-1.4-2.3-.5-.4-1-.6-1-.9 0-.3.3-.5.7-.5.5 0 .9.2 1.2.4l.2.1.3-2.3c-.4-.2-1-.3-1.6-.3zm-8.2 0l-1.4 8.8h3l1.4-8.8h-3zM34.6 9.1l-1.2-3.4H31l-2.4 8.8h3.1l.4-1.5h2.4l.3 1.5h2.9L34.6 9.1zm-2.8 3.8l.7-2.4.4 2.4h-1.1z" fill="#fff"/></svg>
                                        <!-- Ícone da Mastercard -->
                                        <svg viewBox="0 0 38 24" xmlns="http://www.w3.org/2000/svg"><path d="M35 0H3C1.3 0 0 1.3 0 3v18c0 1.7 1.4 3 3 3h32c1.7 0 3-1.3 3-3V3c0-1.7-1.4-3-3-3z" fill="#222"/><path d="M15 12a7 7 0 100-14 7 7 0 000 14z" fill="#EB001B"/><path d="M23 12a7 7 0 110-14 7 7 0 010 14z" fill="#F79E1B"/><path d="M19 12a7 7 0 01-8-7 7 7 0 000 14 7 7 0 008-7z" fill="#FF5F00"/></svg>
                                    </span>
                                </label>
                            </div>

                            <button type="submit" class="action-button" id="submit-order" disabled>Finalizar Pedido</button>
                        </form>
                    </div>
                </div>
                 <div id="order-success-message" style="display: none;">
                    <h3>Obrigado pelo seu pedido!</h3>
                    <p>Ele já foi enviado para a nossa cozinha e em breve chegará até você.</p>
                </div>
                <div id="payment-status-message" style="display: none;">
                    <h3>Status do Pagamento</h3>
                    <p id="payment-status-text"></p>
                    <button class="action-button" onclick="window.location.href='/cardapio'">Voltar ao Cardápio</button>
                </div>
            </aside>
        </div>
    </div>

    <!-- Modal de Seleção -->
    <div id="selection-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div id="modal-header" class="modal-header"></div>
            <div id="modal-body" class="modal-body"></div>
            <div class="modal-footer">
                <div id="modal-feedback" class="modal-feedback"></div>
                <button id="add-to-cart-btn" class="action-button">Adicionar ao Carrinho</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // O script JS permanece o mesmo da versão anterior, com a adição
        // da chamada à função checkPaymentStatusFromURL no final.
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'http://localhost:10000';
            const socket = io(API_BASE_URL);

            const dom = {
                productsGrid: document.getElementById('products-grid'),
                combosGrid: document.getElementById('combos-grid'),
                cartItemsContainer: document.getElementById('cart-items'),
                subtotalEl: document.getElementById('subtotal'),
                deliveryFeeEl: document.getElementById('delivery-fee'),
                grandTotalEl: document.getElementById('grand-total'),
                orderForm: document.getElementById('order-form'),
                submitOrderBtn: document.getElementById('submit-order'),
                cartWrapper: document.getElementById('cart-wrapper'),
                successMessage: document.getElementById('order-success-message'),
                paymentStatusMessage: document.getElementById('payment-status-message'),
                paymentStatusText: document.getElementById('payment-status-text'),
                storeStatusBanner: document.getElementById('store-status-banner'),
                modal: document.getElementById('selection-modal'),
                modalHeader: document.getElementById('modal-header'),
                modalBody: document.getElementById('modal-body'),
                modalFeedback: document.getElementById('modal-feedback'),
                addToCartBtn: document.getElementById('add-to-cart-btn'),
                clearCartBtn: document.getElementById('clear-cart-btn'),
                addressGroup: document.getElementById('address-group'),
                clientAddressInput: document.getElementById('client-address'),
                deliveryFeeRow: document.getElementById('delivery-fee-row'),
                storeNameHeader: document.getElementById('store-name-header'),
                themeSwitcher: document.getElementById('theme-switcher'),
            };

            let cart = [];
            let allItems = []; 
            let allProductsFlat = [];
            let productParentMap = {};
            let storeSettings = {};
            let liveStockState = {};

            const apiFetch = async (endpoint, options = {}) => {
                options.headers = { ...options.headers, 'Content-Type': 'application/json' };
                const response = await fetch(`${API_BASE_URL}/api${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `Erro HTTP: ${response.status}` }));
                    throw new Error(errorData.error);
                }
                return response.status === 204 ? null : response.json();
            };
            
            const checkPaymentStatusFromURL = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const status = urlParams.get('status');
                const orderId = urlParams.get('order_id');

                if (status && orderId) {
                    dom.cartWrapper.style.display = 'none';
                    dom.successMessage.style.display = 'none';
                    dom.paymentStatusMessage.style.display = 'block';
                    let message = '';
                    switch (status) {
                        case 'success':
                            message = `Pagamento para o pedido #${orderId} foi aprovado com sucesso! Já estamos a preparar tudo.`;
                            break;
                        case 'failure':
                            message = `O pagamento para o pedido #${orderId} falhou. Por favor, tente novamente ou escolha outra forma de pagamento.`;
                            break;
                        case 'pending':
                            message = `O pagamento para o pedido #${orderId} está pendente. Avisaremos assim que for aprovado.`;
                            break;
                    }
                    dom.paymentStatusText.textContent = message;
                    window.history.replaceState({}, document.title, "/cardapio");
                }
            };

            dom.orderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                dom.submitOrderBtn.disabled = true;
                dom.submitOrderBtn.textContent = 'A processar...';
                
                const deliveryType = document.querySelector('input[name="delivery-type"]:checked').value;
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
                const address = deliveryType === 'delivery' ? dom.clientAddressInput.value : 'Retirada no local';
                
                const itemsForBackend = cart.map(item => ({
                    id: item.original_id, name: item.name, price: item.price, quantity: item.quantity, is_combo: !!item.is_combo, selected_items: item.selected_items || []
                }));

                const orderData = {
                    client_name: document.getElementById('client-name').value,
                    client_phone: document.getElementById('client-phone').value,
                    client_address: address,
                    items: itemsForBackend,
                    total_price: parseFloat(dom.grandTotalEl.textContent.replace('R$ ', '').replace(',', '.')),
                    payment_method: paymentMethod
                };
                
                try {
                    const createdOrder = await apiFetch('/public/orders', { method: 'POST', body: JSON.stringify(orderData) });
                    
                    if (paymentMethod === 'online') {
                        dom.submitOrderBtn.textContent = 'A redirecionar para o pagamento...';
                        const preference = await apiFetch(`/payments/create-preference/${createdOrder.id}`, { method: 'POST' });
                        window.location.href = preference.checkout_url;
                    } else {
                        dom.cartWrapper.style.display = 'none';
                        dom.successMessage.style.display = 'block';
                        cart = [];
                    }
                } catch (error) {
                    alert(`Desculpe, não foi possível processar seu pedido. Erro: ${error.message}`);
                    dom.submitOrderBtn.disabled = false;
                    dom.submitOrderBtn.textContent = 'Finalizar Pedido';
                }
            });

            const applyTheme = (theme) => {
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('pamonharia-theme', theme);
            };

            const getAvailableStock = (item) => {
                if (!item) return 0;
                const parentId = productParentMap[item.id];
                if (parentId) {
                    const parent = allProductsFlat.find(p => p.id === parentId);
                    if (parent && parent.stock_sync_enabled && parent.stock_enabled) {
                        return liveStockState[parent.id] || 0;
                    }
                }
                if (item.stock_enabled) {
                    return liveStockState[item.id] || 0;
                }
                return Infinity;
            };

            const isItemEffectivelyOutOfStock = (item) => {
                if (!item) return true; 
                if (item.children && item.children.length > 0 && !item.sell_parent_product) {
                    return item.children.every(child => {
                        const childData = allProductsFlat.find(p => p.id === child.id);
                        return isItemEffectivelyOutOfStock(childData);
                    });
                }
                return getAvailableStock(item) <= 0;
            };

            const isComboEffectivelyOutOfStock = (combo) => {
                if (!combo || !combo.products) return true;
                const totalAvailableStock = combo.products.reduce((sum, product) => {
                    const fullProductData = allProductsFlat.find(p => p.id === product.id);
                    return sum + getAvailableStock(fullProductData);
                }, 0);
                return totalAvailableStock < combo.total_items_limit;
            };

            const renderItems = () => {
                dom.productsGrid.innerHTML = '';
                dom.combosGrid.innerHTML = '';
                const activeProducts = allItems.filter(item => !item.is_combo && item.is_main_product);
                const activeCombos = allItems.filter(item => item.is_combo);
                document.getElementById('products-section').style.display = activeProducts.length > 0 ? 'block' : 'none';
                document.getElementById('combos-section').style.display = activeCombos.length > 0 ? 'block' : 'none';
                document.getElementById('section-divider').style.display = activeProducts.length > 0 && activeCombos.length > 0 ? 'block' : 'none';

                allItems.forEach(item => {
                    if (!item.status) return;
                    const grid = item.is_combo ? dom.combosGrid : dom.productsGrid;
                    if (!grid || (!item.is_main_product && !item.is_combo)) return;
                    
                    let priceText;
                    if (item.is_combo) {
                        priceText = `A partir de R$ ${parseFloat(item.price).toFixed(2).replace('.',',')}`;
                    } else if (item.children && item.children.length > 0 && !item.sell_parent_product) {
                        const availableChildren = item.children.filter(c => !isItemEffectivelyOutOfStock(allProductsFlat.find(p => p.id === c.id)));
                        if (availableChildren.length > 0) {
                            const minPrice = Math.min(...availableChildren.map(c => c.price));
                            priceText = `A partir de R$ ${parseFloat(minPrice).toFixed(2).replace('.',',')}`;
                        } else {
                            priceText = 'Opções esgotadas';
                        }
                    } else {
                        priceText = `R$ ${parseFloat(item.price).toFixed(2).replace('.',',')}`;
                    }
                    
                    const hasOptions = (item.children && item.children.length > 0) || (item.is_combo);
                    const isOutOfStock = item.is_combo ? isComboEffectivelyOutOfStock(item) : isItemEffectivelyOutOfStock(item);
                    
                    const onClickAction = item.is_combo 
                        ? `openComboModal(${item.id})` 
                        : (hasOptions
                            ? `openProductWithOptionsModal(${item.id})` 
                            : `addToCartSimple(${item.id})`);

                    grid.innerHTML += `
                        <div class="item-card ${isOutOfStock ? 'out-of-stock' : ''}" data-id="${item.id}">
                            <div class="stock-overlay">${isOutOfStock ? 'Esgotado' : ''}</div>
                            <img src="${item.image_url || 'https://placehold.co/400x250/f59e0b/FFF?text=Pamonha'}" alt="${item.name}" class="item-image">
                            <div class="item-info">
                                <h3>${item.name}</h3>
                                <p class="description">${item.description || ''}</p>
                                <div class="item-price">${priceText}</div>
                                <button class="action-button" onclick="${onClickAction}" ${!storeSettings.is_open || isOutOfStock ? 'disabled' : ''}>
                                    ${hasOptions ? 'Montar' : 'Adicionar'}
                                </button>
                            </div>
                        </div>`;
                });
            };

            const renderCart = () => {
                dom.clearCartBtn.style.display = cart.length > 0 ? 'inline-block' : 'none';
                if (cart.length === 0) {
                    dom.cartItemsContainer.innerHTML = '<p id="empty-cart-msg">Seu carrinho está vazio.</p>';
                    dom.submitOrderBtn.disabled = true;
                } else {
                    dom.cartItemsContainer.innerHTML = '';
                    cart.forEach((item, index) => {
                        let itemDetails = '';
                        if (item.selected_items && item.selected_items.length > 0) {
                            itemDetails = `<small>${item.selected_items.map(si => si.name).join(', ')}</small>`;
                        }
                        dom.cartItemsContainer.innerHTML += `<div class="cart-item" data-cart-item-id="${item.cart_id}"><img src="${item.image_url || 'https://placehold.co/60x60/f59e0b/FFF?text=Item'}" alt="${item.name}" class="cart-item-image"><div class="cart-item-info"><strong>${item.quantity}x ${item.name}</strong>${itemDetails}</div><div class="cart-item-controls"><button onclick="removeFromCart(${index})">Remover</button><span>R$ ${(item.price * item.quantity).toFixed(2).replace('.',',')}</span></div></div>`;
                    });
                    dom.submitOrderBtn.disabled = !storeSettings.is_open;
                }
                calculateTotals();
            };

            const calculateTotals = () => {
                const subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
                const isDelivery = document.querySelector('input[name="delivery-type"]:checked').value === 'delivery';
                const deliveryFee = isDelivery ? parseFloat(storeSettings.delivery_fee || 0) : 0;
                dom.deliveryFeeRow.style.display = isDelivery ? 'flex' : 'none';
                const grandTotal = subtotal + deliveryFee;
                dom.subtotalEl.textContent = `R$ ${subtotal.toFixed(2).replace('.',',')}`;
                dom.deliveryFeeEl.textContent = `R$ ${deliveryFee.toFixed(2).replace('.',',')}`;
                dom.grandTotalEl.textContent = `R$ ${grandTotal.toFixed(2).replace('.',',')}`;
            };
            
            const updateStoreStatus = () => {
                const now = new Date();
                const dayOfWeek = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'][now.getDay()];
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                let isOpen = false;
                if (storeSettings.is_open_manual_override !== null) {
                    isOpen = storeSettings.is_open_manual_override;
                } else {
                    const schedule = storeSettings.operating_hours?.[dayOfWeek];
                    if (schedule && schedule.enabled) {
                        isOpen = currentTime >= schedule.open && currentTime <= schedule.close;
                    }
                }
                storeSettings.is_open = isOpen;
                dom.storeStatusBanner.style.display = 'block';
                if (isOpen) {
                    dom.storeStatusBanner.textContent = 'Loja Aberta! Faça seu pedido.';
                    dom.storeStatusBanner.className = 'open';
                } else {
                    dom.storeStatusBanner.textContent = 'Loja Fechada. Não estamos a aceitar pedidos no momento.';
                    dom.storeStatusBanner.className = 'closed';
                }
                if(storeSettings.store_name) dom.storeNameHeader.textContent = storeSettings.store_name;
            };

            const handleQuantityChange = (target, state, validator, item, options = {}) => {
                const itemId = parseInt(target.dataset.itemId);
                const isIncrement = target.textContent === '+';
                
                let currentTotalQuantityInModalForSyncGroup = 0;
                let stockHoldingProduct = item;
                
                const parentId = productParentMap[item.id];
                if (parentId) {
                    const parent = allProductsFlat.find(p => p.id === parentId);
                    if (parent && parent.stock_sync_enabled) {
                        stockHoldingProduct = parent;
                        currentTotalQuantityInModalForSyncGroup = Object.entries(state)
                            .filter(([key, _]) => productParentMap[key] === parentId)
                            .reduce((sum, [_, qty]) => sum + qty, 0);
                    }
                }
                
                if (isIncrement && options.isComplement && options.oneToOneRuleActive) {
                    const parentQty = options.getParentQty();
                    const totalComplements = options.getTotalComplementsQty();
                    if (totalComplements >= parentQty) {
                        const feedbackMsg = `Limite de complementos atingido (${parentQty}).`;
                        dom.modalFeedback.textContent = feedbackMsg;
                        setTimeout(() => dom.modalFeedback.textContent = '', 3000);
                        return;
                    }
                }

                if (isIncrement) {
                    const availableStock = getAvailableStock(item);
                    const currentQuantity = stockHoldingProduct.id === item.id ? (state[itemId] || 0) : currentTotalQuantityInModalForSyncGroup;
                    if (availableStock !== Infinity && currentQuantity >= availableStock) {
                         const feedbackMsg = `Limite de estoque para "${stockHoldingProduct.name}" atingido: ${availableStock} unid.`;
                        dom.modalFeedback.textContent = feedbackMsg;
                        setTimeout(() => dom.modalFeedback.textContent = '', 3000);
                        return;
                    }
                    state[itemId] = (state[itemId] || 0) + 1;
                } else {
                    state[itemId] = Math.max(0, (state[itemId] || 0) - 1);
                }
                
                document.getElementById(`quantity-${itemId}`).textContent = state[itemId];
                if (validator) validator();
            };

            const addToCartAndReserve = (itemData, itemsToReserve) => {
                socket.emit('reserve_stock', itemsToReserve);
                socket.once('reservation_success', () => {
                    cart.push({ ...itemData, cart_id: `cart_${Date.now()}` });
                    renderCart();
                    dom.modal.style.display = 'none';
                });
                socket.once('reservation_failure', ({ message }) => {
                    dom.modalFeedback.textContent = `Erro: ${message}`;
                });
            };

            window.addToCartSimple = (itemId) => {
                const item = allProductsFlat.find(p => p.id === itemId);
                if (!item || isItemEffectivelyOutOfStock(item)) return;
                const itemsToReserve = [{ id: item.id, quantity: 1 }];
                const itemData = { original_id: item.id, name: item.name, price: item.price, image_url: item.image_url, quantity: 1 };
                addToCartAndReserve(itemData, itemsToReserve);
            };
            
            window.removeFromCart = (cartIndex) => {
                const itemToRemove = cart[cartIndex];
                if (!itemToRemove) return;
                let itemsToRelease = [];
                if (itemToRemove.is_combo || itemToRemove.has_addons) {
                    const parentData = allProductsFlat.find(p => p.id === itemToRemove.original_id);
                    const isStockSynced = parentData && parentData.stock_sync_enabled;
                    if (isStockSynced) {
                        itemsToRelease.push({ id: itemToRemove.original_id, quantity: itemToRemove.quantity });
                    } else {
                        itemToRemove.selected_items.forEach(si => itemsToRelease.push({ id: si.id, quantity: si.quantity }));
                        if(itemToRemove.has_addons && itemToRemove.sell_parent_product) {
                            itemsToRelease.push({ id: itemToRemove.original_id, quantity: itemToRemove.quantity });
                        }
                    }
                } else {
                    itemsToRelease.push({ id: itemToRemove.original_id, quantity: itemToRemove.quantity });
                }
                socket.emit('release_stock', itemsToRelease.filter(i => i && i.id));
                cart.splice(cartIndex, 1);
                renderCart();
            };

            dom.clearCartBtn.addEventListener('click', () => {
                if (cart.length === 0) return;
                const allItemsToRelease = cart.flatMap(item => {
                    if (item.is_combo || item.has_addons) {
                         const parentData = allProductsFlat.find(p => p.id === item.original_id);
                         const isStockSynced = parentData && parentData.stock_sync_enabled;
                         if (isStockSynced) {
                            return [{ id: item.original_id, quantity: item.quantity }];
                         } else {
                             const children = item.selected_items.map(si => ({ id: si.id, quantity: si.quantity }));
                             if(item.has_addons && item.sell_parent_product) {
                                children.push({ id: item.original_id, quantity: item.quantity });
                             }
                             return children;
                         }
                    }
                    return [{ id: item.original_id, quantity: item.quantity }];
                }).filter(i => i && i.id);
                socket.emit('release_stock', allItemsToRelease);
                cart = [];
                renderCart();
            });
            
            const setupModal = (config) => {
                dom.modalHeader.innerHTML = `<h3>${config.title}</h3><p>${config.description}</p>`;
                dom.modalBody.innerHTML = config.body || '';
                dom.modalFeedback.textContent = '';
                dom.addToCartBtn.textContent = 'Adicionar ao Carrinho';
                dom.addToCartBtn.onclick = config.onSave;
                dom.modal.querySelector('.modal-close-btn').onclick = () => dom.modal.style.display = 'none';
                dom.modal.style.display = 'flex';
                if(config.onOpen) config.onOpen();
            };
            
            window.openProductWithOptionsModal = (productId) => {
                const product = allItems.find(item => item.id === productId);
                if (!product) return;
                let selectedItemsInModal = {};
                let bodyHtml = '';
                const initialParentQty = (product.sell_parent_product || !product.children || product.children.length === 0) ? 1 : 0;
                if (product.sell_parent_product) {
                    const isParentOutOfStock = isItemEffectivelyOutOfStock(product);
                    bodyHtml += `<div class="modal-parent-item"><span>${product.name} (Base)</span><div class="quantity-control"><button data-item-id="${product.id}" ${isParentOutOfStock ? 'disabled' : ''}>-</button><span id="quantity-${product.id}">${initialParentQty}</span><button data-item-id="${product.id}" ${isParentOutOfStock ? 'disabled' : ''}>+</button></div></div>`;
                    if (initialParentQty > 0) selectedItemsInModal[product.id] = initialParentQty;
                }
                if (product.children && product.children.length > 0) {
                    bodyHtml += `<h4>${product.sell_parent_product ? 'Adicione complementos:' : 'Escolha os sabores:'}</h4>`;
                    product.children.forEach(option => {
                        const fullOptionData = allProductsFlat.find(p => p.id === option.id);
                        const isOptionOutOfStock = isItemEffectivelyOutOfStock(fullOptionData);
                        bodyHtml += `<div class="modal-item-option ${isOptionOutOfStock ? 'disabled' : ''}"><label>${option.name} (R$ ${parseFloat(option.price).toFixed(2).replace('.',',')})</label><div class="quantity-control"><button data-item-id="${option.id}" data-is-complement="true" ${isOptionOutOfStock ? 'disabled' : ''}>-</button><span id="quantity-${option.id}">0</span><button data-item-id="${option.id}" data-is-complement="true" ${isOptionOutOfStock ? 'disabled' : ''}>+</button></div></div>`;
                    });
                }
                const onSave = () => {
                    let finalPrice = 0, finalQuantity, selected_items_details = [], itemsToReserve = [];
                    const parentData = allProductsFlat.find(p => p.id === product.id);
                    const isStockSynced = parentData && parentData.stock_sync_enabled;
                    if (isStockSynced) {
                        let totalQuantityToReserve = product.sell_parent_product ? (selectedItemsInModal[product.id] || 0) : Object.entries(selectedItemsInModal).filter(([id, _]) => parseInt(id) !== product.id).reduce((sum, [_, qty]) => sum + qty, 0);
                        if (totalQuantityToReserve > 0) itemsToReserve.push({ id: product.id, quantity: totalQuantityToReserve });
                    } else {
                        for (const [id, quantity] of Object.entries(selectedItemsInModal)) {
                            if (quantity > 0) {
                                const selectedItem = allProductsFlat.find(i => i.id == id);
                                if (selectedItem) itemsToReserve.push({ id: selectedItem.id, quantity: quantity });
                            }
                        }
                    }
                    finalQuantity = !product.sell_parent_product ? Object.entries(selectedItemsInModal).filter(([id, _]) => id != product.id).reduce((sum, [_, qty]) => sum + qty, 0) : (selectedItemsInModal[product.id] || 1);
                    for (const [id, quantity] of Object.entries(selectedItemsInModal)) {
                        if (quantity > 0) {
                            const selectedItem = allProductsFlat.find(i => i.id == id);
                            if (!selectedItem) continue;
                            if (product.sell_parent_product && selectedItem.id === product.id) finalPrice += parseFloat(selectedItem.price) * quantity;
                            if (selectedItem.id !== product.id) {
                                finalPrice += parseFloat(selectedItem.price) * quantity;
                                selected_items_details.push({ id: selectedItem.id, name: `${quantity}x ${selectedItem.name}`, quantity: quantity });
                            }
                        }
                    }
                    const finalItemPrice = finalQuantity > 0 ? finalPrice / finalQuantity : 0;
                    const itemData = { original_id: product.id, name: product.name, price: finalItemPrice, quantity: finalQuantity, has_addons: true, sell_parent_product: product.sell_parent_product, selected_items: selected_items_details, image_url: product.image_url };
                    addToCartAndReserve(itemData, itemsToReserve);
                };
                const validator = () => {
                    const totalSelected = Object.values(selectedItemsInModal).reduce((sum, qty) => sum + qty, 0);
                    let isValid = totalSelected > 0, totalQuantityForButton = 0;
                    if (product.force_one_to_one_complement) {
                        const parentQty = selectedItemsInModal[product.id] || 0;
                        totalQuantityForButton = parentQty;
                        const totalComplementsQty = Object.entries(selectedItemsInModal).filter(([id, _]) => id != product.id).reduce((sum, [_, qty]) => sum + qty, 0);
                        const diff = parentQty - totalComplementsQty;
                        dom.modalFeedback.textContent = diff > 0 ? `Selecione mais ${diff} complemento(s).` : (diff < 0 ? `Remova ${-diff} complemento(s).` : '');
                        isValid = (parentQty === totalComplementsQty) && parentQty > 0;
                    } else if (!product.sell_parent_product) {
                        totalQuantityForButton = Object.entries(selectedItemsInModal).filter(([id, _]) => id != product.id).reduce((sum, [_, qty]) => sum + qty, 0);
                        isValid = totalQuantityForButton > 0;
                    } else {
                        totalQuantityForButton = selectedItemsInModal[product.id] || 0;
                        isValid = totalQuantityForButton > 0;
                        dom.modalFeedback.textContent = '';
                    }
                    dom.addToCartBtn.textContent = (isValid && totalQuantityForButton > 0) ? `Adicionar (${totalQuantityForButton}) ao Carrinho` : 'Adicionar ao Carrinho';
                    dom.addToCartBtn.disabled = !isValid;
                };
                setupModal({ title: `Adicionar ${product.name}`, description: product.force_one_to_one_complement ? 'Escolha a mesma quantidade de complementos que a do item principal.' : 'Selecione as opções.', body: bodyHtml, onSave, onOpen: validator });
                dom.modalBody.querySelectorAll('.quantity-control button[data-item-id]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const optionId = e.target.dataset.itemId;
                        const option = allProductsFlat.find(i => i.id == optionId);
                        if (option) {
                            const changeOptions = { isComplement: e.target.dataset.isComplement === 'true', oneToOneRuleActive: product.force_one_to_one_complement, getParentQty: () => selectedItemsInModal[product.id] || 0, getTotalComplementsQty: () => Object.entries(selectedItemsInModal).filter(([id, _]) => id != product.id).reduce((sum, [_, qty]) => sum + qty, 0) };
                            handleQuantityChange(e.target, selectedItemsInModal, validator, option, changeOptions);
                        }
                    });
                });
            };

            window.openComboModal = (comboId) => {
                const combo = allItems.find(item => item.id === comboId);
                if (!combo) return;
                let selectedQuantities = {}, comboBodyHtml = '';
                combo.products.forEach(option => {
                    const fullOptionData = allProductsFlat.find(p => p.id === option.id);
                    const isOptionOutOfStock = isItemEffectivelyOutOfStock(fullOptionData);
                    const priceModifierText = option.price_modifier > 0 ? `+ R$ ${parseFloat(option.price_modifier).toFixed(2).replace('.',',')}` : '';
                    comboBodyHtml += `<div class="modal-item-option ${isOptionOutOfStock ? 'disabled' : ''}"><label>${option.name} ${isOptionOutOfStock ? '<small>(Esgotado)</small>' : ''}</label><span class="price-modifier">${priceModifierText}</span><div class="quantity-control"><button data-item-id="${option.id}" ${isOptionOutOfStock ? 'disabled' : ''}>-</button><span id="quantity-${option.id}">0</span><button data-item-id="${option.id}" ${isOptionOutOfStock ? 'disabled' : ''}>+</button></div></div>`;
                });
                const validator = () => {
                    const totalSelected = Object.values(selectedQuantities).reduce((sum, qty) => sum + qty, 0);
                    const totalLimit = combo.total_items_limit;
                    dom.addToCartBtn.disabled = totalSelected !== totalLimit;
                    dom.modalFeedback.textContent = '';
                    dom.addToCartBtn.textContent = `Adicionar (${totalSelected}/${totalLimit}) ao Carrinho`;
                };
                const onSave = () => {
                    let finalPrice = parseFloat(combo.price), selected_items = [], itemsToReserve = [];
                    for (const [id, quantity] of Object.entries(selectedQuantities)) {
                        if (quantity > 0) {
                            const product = allProductsFlat.find(p => p.id == id);
                            const comboProductInfo = combo.products.find(p => p.id == id);
                            finalPrice += parseFloat(comboProductInfo.price_modifier || 0) * quantity;
                            selected_items.push({ id: product.id, name: `${quantity}x ${product.name}`, quantity: quantity });
                            itemsToReserve.push({ id: product.id, quantity });
                        }
                    }
                    const itemData = { original_id: combo.id, name: combo.name, price: finalPrice, is_combo: true, quantity: 1, selected_items, image_url: combo.image_url };
                    addToCartAndReserve(itemData, itemsToReserve);
                };
                setupModal({ title: `Montar ${combo.name}`, description: `Selecione exatamente ${combo.total_items_limit} itens.`, body: comboBodyHtml, onSave, onOpen: validator });
                dom.modalBody.querySelectorAll('.quantity-control button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const totalLimit = combo.total_items_limit;
                        const currentTotal = Object.values(selectedQuantities).reduce((s, q) => s + q, 0);
                        if (e.target.textContent === '+' && currentTotal >= totalLimit) {
                             dom.modalFeedback.textContent = `Você já selecionou o limite de ${totalLimit} itens.`;
                             setTimeout(() => dom.modalFeedback.textContent = '', 2500);
                             return;
                        }
                        const optionId = e.target.dataset.itemId;
                        const option = allProductsFlat.find(p => p.id == optionId);
                        if(option) handleQuantityChange(e.target, selectedQuantities, validator, option);
                    });
                });
            };
            
            const fetchAndRenderAll = async () => {
                try {
                    const [productsResponse, combosResponse, settingsResponse] = await Promise.all([ apiFetch('/public/products'), apiFetch('/public/combos'), apiFetch('/public/settings') ]);
                    storeSettings = settingsResponse;
                    allProductsFlat = [];
                    productParentMap = {};
                    const recursiveFlattenAndMap = (products, parent = null) => {
                        if (!products) return;
                        products.forEach(p => {
                            allProductsFlat.push(p);
                            if (parent) productParentMap[p.id] = parent.id;
                            if (p.children && p.children.length > 0) recursiveFlattenAndMap(p.children, p);
                        });
                    };
                    recursiveFlattenAndMap(productsResponse);
                    combosResponse.forEach(c => { if (c.products) c.products = c.products.map(p => allProductsFlat.find(i => i.id === p.id) || p); });
                    allItems = [...combosResponse.map(c => ({...c, is_combo: true})), ...productsResponse];
                    updateStoreStatus();
                    renderItems();
                    renderCart();
                } catch (error) { document.body.innerHTML = '<h1>Erro ao carregar o cardápio. Tente novamente mais tarde.</h1>'; }
            };
            
            socket.on('connect', () => console.log('[Cardapio] ✅ Socket.IO conectado ao servidor.'));
            socket.on('stock_update', (inventory) => { liveStockState = inventory; renderItems(); });
            socket.on('data_updated', fetchAndRenderAll);
            dom.themeSwitcher.addEventListener('click', () => {
                const currentTheme = document.body.getAttribute('data-theme');
                applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });
            document.querySelectorAll('input[name="delivery-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isDelivery = e.target.value === 'delivery';
                    dom.addressGroup.style.display = isDelivery ? 'block' : 'none';
                    dom.clientAddressInput.required = isDelivery;
                    calculateTotals();
                });
            });
            const savedTheme = localStorage.getItem('pamonharia-theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
            fetchAndRenderAll();
            checkPaymentStatusFromURL();
        });
    </script>
</body>
</html>
