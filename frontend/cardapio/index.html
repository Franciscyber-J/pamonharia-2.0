<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio - Pamonharia Sabor do Goiás</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-center">
                <h1 id="store-name-header">Pamonharia Sabor do Goiás</h1>
                <p>O verdadeiro sabor da fazenda, direto para a sua mesa!</p>
            </div>
            <button id="theme-switcher" class="theme-switcher" title="Alterar tema">
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
        </header>

        <div id="store-status-banner"></div>

        <div class="content-wrapper">
            <main>
                <div id="combos-section" style="display: none;">
                    <h2 class="section-title">Nossos Combos</h2>
                    <div id="combos-grid" class="items-grid"></div>
                </div>
                <hr id="section-divider" style="margin: 40px 0; border: 1px solid var(--border-color); display: none;">
                <div id="products-section" style="display: none;">
                    <h2 class="section-title">Produtos Individuais</h2>
                    <div id="products-grid" class="items-grid"></div>
                </div>
            </main>
            <aside>
                <div id="cart-wrapper" class="cart-container">
                    <h2>Meu Carrinho</h2>
                    <div id="cart-items">
                        <p id="empty-cart-msg">Seu carrinho está vazio.</p>
                    </div>
                    <div class="cart-totals">
                        <div class="total-row"><span>Subtotal</span><span id="subtotal">R$ 0,00</span></div>
                        <div class="total-row"><span>Taxa de Entrega</span><span id="delivery-fee">R$ 0,00</span></div>
                        <div class="total-row grand-total"><span>Total</span><span id="grand-total">R$ 0,00</span></div>
                    </div>
                    <div class="checkout-form">
                        <h3>Finalizar Pedido</h3>
                        <form id="order-form">
                            <label for="client-name">Nome</label>
                            <input type="text" id="client-name" required>
                            <label for="client-phone">Contacto (WhatsApp)</label>
                            <input type="tel" id="client-phone" required>
                            <label for="client-address">Endereço de Entrega</label>
                            <input type="text" id="client-address" required>
                            <button type="submit" class="action-button" id="submit-order" disabled>Finalizar Pedido</button>
                        </form>
                    </div>
                </div>
                 <div id="order-success-message" style="display: none;">
                    <h3>Obrigado pelo seu pedido!</h3>
                    <p>Ele já foi enviado para a nossa cozinha e em breve chegará até você.</p>
                </div>
            </aside>
        </div>
    </div>

    <!-- Modal Genérico para Seleção de Itens -->
    <div id="selection-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div id="modal-header" class="modal-header"></div>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-footer" class="modal-footer">
                <button id="add-to-cart-btn" class="action-button">Adicionar ao Carrinho</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'http://localhost:10000';
            
            const dom = {
                productsGrid: document.getElementById('products-grid'),
                combosGrid: document.getElementById('combos-grid'),
                cartItemsContainer: document.getElementById('cart-items'),
                subtotalEl: document.getElementById('subtotal'),
                deliveryFeeEl: document.getElementById('delivery-fee'),
                grandTotalEl: document.getElementById('grand-total'),
                orderForm: document.getElementById('order-form'),
                submitOrderBtn: document.getElementById('submit-order'),
                cartWrapper: document.getElementById('cart-wrapper'),
                successMessage: document.getElementById('order-success-message'),
                storeStatusBanner: document.getElementById('store-status-banner'),
                storeNameHeader: document.getElementById('store-name-header'),
                modal: document.getElementById('selection-modal'),
                modalHeader: document.getElementById('modal-header'),
                modalBody: document.getElementById('modal-body'),
                addToCartBtn: document.getElementById('add-to-cart-btn'),
                themeSwitcher: document.getElementById('theme-switcher')
            };

            let cart = [];
            let storeSettings = {};
            let allItems = [];

            const applyTheme = (theme) => {
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('pamonharia-theme', theme);
            };
            dom.themeSwitcher.addEventListener('click', () => {
                const currentTheme = document.body.getAttribute('data-theme');
                applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });
            const savedTheme = localStorage.getItem('pamonharia-theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));

            const renderItems = (items) => {
                dom.productsGrid.innerHTML = '';
                dom.combosGrid.innerHTML = '';
                
                const activeProducts = items.filter(item => !item.is_combo);
                const activeCombos = items.filter(item => item.is_combo);

                document.getElementById('products-section').style.display = activeProducts.length > 0 ? 'block' : 'none';
                document.getElementById('combos-section').style.display = activeCombos.length > 0 ? 'block' : 'none';
                document.getElementById('section-divider').style.display = activeProducts.length > 0 && activeCombos.length > 0 ? 'block' : 'none';

                items.forEach(item => {
                    const grid = item.is_combo ? dom.combosGrid : dom.productsGrid;
                    const priceText = item.is_combo ? `A partir de R$ ${parseFloat(item.price).toFixed(2).replace('.',',')}` : `R$ ${parseFloat(item.price).toFixed(2).replace('.',',')}`;
                    const buttonText = (item.is_combo || (item.children && item.children.length > 0)) ? 'Montar' : 'Adicionar';
                    const onClickAction = item.is_combo ? `openComboModal(${item.id})` : (item.children && item.children.length > 0 ? `openProductWithOptionsModal(${item.id})` : `addToCart({ id: ${item.id}, name: '${item.name}', price: ${item.price} })`);

                    grid.innerHTML += `
                        <div class="item-card">
                            <img src="${item.image_url || 'https://placehold.co/400x250/f59e0b/FFF?text=Pamonha'}" alt="${item.name}" class="item-image">
                            <div class="item-info">
                                <h3>${item.name}</h3>
                                <p class="description">${item.description || ''}</p>
                                <div class="item-price">${priceText}</div>
                                <button class="action-button" onclick="${onClickAction}" ${!storeSettings.is_open ? 'disabled' : ''}>${buttonText}</button>
                            </div>
                        </div>
                    `;
                });
            };

            const renderCart = () => {
                if (cart.length === 0) {
                    dom.cartItemsContainer.innerHTML = '<p id="empty-cart-msg">Seu carrinho está vazio.</p>';
                    dom.submitOrderBtn.disabled = true;
                } else {
                    dom.cartItemsContainer.innerHTML = '';
                    cart.forEach((item, index) => {
                        let itemDetails = '';
                        if (item.selected_items && item.selected_items.length > 0) {
                            itemDetails = `<small>${item.selected_items.map(si => si.name).join(', ')}</small>`;
                        }
                        dom.cartItemsContainer.innerHTML += `
                            <div class="cart-item">
                                <div class="cart-item-info">
                                    <strong>${item.quantity}x ${item.name}</strong>
                                    ${itemDetails}
                                </div>
                                <div class="cart-item-controls">
                                    <button onclick="updateQuantity(${index}, -1)">-</button>
                                    <span>R$ ${item.price.toFixed(2).replace('.',',')}</span>
                                    <button onclick="updateQuantity(${index}, 1)" style="visibility: ${item.is_combo || item.has_addons ? 'hidden' : 'visible'};">+</button>
                                </div>
                            </div>`;
                    });
                    dom.submitOrderBtn.disabled = !storeSettings.is_open;
                }
                calculateTotals();
            };

            const calculateTotals = () => {
                const subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
                const deliveryFee = parseFloat(storeSettings.delivery_fee || 0);
                const grandTotal = subtotal + deliveryFee;
                dom.subtotalEl.textContent = `R$ ${subtotal.toFixed(2).replace('.',',')}`;
                dom.deliveryFeeEl.textContent = `R$ ${deliveryFee.toFixed(2).replace('.',',')}`;
                dom.grandTotalEl.textContent = `R$ ${grandTotal.toFixed(2).replace('.',',')}`;
            };

            const updateStoreStatus = (settings) => {
                storeSettings = settings;
                const now = new Date();
                const dayOfWeek = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'][now.getDay()];
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                let isOpen = false;
                if (settings.is_open_manual_override !== null) {
                    isOpen = settings.is_open_manual_override;
                } else {
                    const schedule = settings.operating_hours?.[dayOfWeek];
                    if (schedule && schedule.enabled) {
                        isOpen = currentTime >= schedule.open && currentTime <= schedule.close;
                    }
                }
                storeSettings.is_open = isOpen;

                dom.storeStatusBanner.style.display = 'block';
                if (isOpen) {
                    dom.storeStatusBanner.textContent = 'Loja Aberta! Faça seu pedido.';
                    dom.storeStatusBanner.className = 'open';
                } else {
                    dom.storeStatusBanner.textContent = 'Loja Fechada. Não estamos a aceitar pedidos no momento.';
                    dom.storeStatusBanner.className = 'closed';
                }
                
                if(settings.store_name) dom.storeNameHeader.textContent = settings.store_name;
                renderItems(allItems);
                renderCart();
            };

            window.addToCart = (item) => {
                const existingItem = cart.find(cartItem => cartItem.id === item.id && !item.is_combo && !item.has_addons);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cart.push({ ...item, quantity: 1 });
                }
                renderCart();
            };
            
            window.updateQuantity = (index, amount) => {
                cart[index].quantity += amount;
                if (cart[index].quantity <= 0) cart.splice(index, 1);
                renderCart();
            };

            const setupModal = (config) => {
                dom.modalHeader.innerHTML = `<h3>${config.title}</h3><p>${config.description}</p>`;
                dom.modalBody.innerHTML = '';
                config.options.forEach(option => {
                    const priceModifierText = option.price_modifier > 0 ? `+ R$ ${parseFloat(option.price_modifier).toFixed(2).replace('.',',')}` : '';
                    dom.modalBody.innerHTML += `
                        <div class="modal-item-option">
                            <label>${option.name}</label>
                            <span class="price-modifier">${priceModifierText}</span>
                            <div class="quantity-control">
                                <button data-item-id="${option.id}" data-price-modifier="${option.price_modifier}" data-name="${option.name}">-</button>
                                <span id="quantity-${option.id}">0</span>
                                <button data-item-id="${option.id}" data-price-modifier="${option.price_modifier}" data-name="${option.name}">+</button>
                            </div>
                        </div>
                    `;
                });

                dom.addToCartBtn.onclick = config.onSave;
                dom.modal.querySelector('.modal-close-btn').onclick = () => dom.modal.style.display = 'none';
                dom.modal.style.display = 'flex';
                config.onOpen();
            };

            const handleQuantityChange = (target, state, validator) => {
                const itemId = parseInt(target.dataset.itemId);
                const isIncrement = target.textContent === '+';
                
                if (isIncrement) {
                    state[itemId] = (state[itemId] || 0) + 1;
                } else {
                    state[itemId] = Math.max(0, (state[itemId] || 0) - 1);
                }
                
                document.getElementById(`quantity-${itemId}`).textContent = state[itemId];
                validator();
            };

            window.openProductWithOptionsModal = (productId) => {
                const product = allItems.find(item => item.id === productId);
                if (!product || !product.children) return;

                let selectedComplements = {};

                const validator = () => {
                    if(product.force_addons) {
                        const totalSelected = Object.values(selectedComplements).reduce((sum, qty) => sum + qty, 0);
                        dom.addToCartBtn.disabled = totalSelected === 0;
                    }
                };
                
                setupModal({
                    title: `Adicionar ${product.name}`,
                    description: 'Selecione os complementos que desejar.',
                    options: product.children,
                    onOpen: validator,
                    onSave: () => {
                        let finalPrice = parseFloat(product.price);
                        let selected_items = [];
                        for (const [id, quantity] of Object.entries(selectedComplements)) {
                            if (quantity > 0) {
                                const complement = product.children.find(c => c.id == id);
                                finalPrice += parseFloat(complement.price) * quantity;
                                selected_items.push({ id: complement.id, name: `${quantity}x ${complement.name}` });
                            }
                        }
                        addToCart({
                            id: `prod_${product.id}_${Date.now()}`,
                            name: product.name,
                            price: finalPrice,
                            has_addons: true,
                            selected_items: selected_items
                        });
                        dom.modal.style.display = 'none';
                    }
                });

                dom.modalBody.querySelectorAll('.quantity-control button').forEach(button => {
                    button.addEventListener('click', (e) => handleQuantityChange(e.target, selectedComplements, validator));
                });
            };

            window.openComboModal = (comboId) => {
                const combo = allItems.find(item => item.id === comboId && item.is_combo);
                if (!combo) return;

                let selectedQuantities = {};
                
                const validator = () => {
                    const totalSelected = Object.values(selectedQuantities).reduce((sum, qty) => sum + qty, 0);
                    dom.addToCartBtn.disabled = totalSelected !== combo.total_items_limit;
                    dom.addToCartBtn.textContent = `Adicionar (${totalSelected}/${combo.total_items_limit}) ao Carrinho`;
                };

                setupModal({
                    title: `Montar ${combo.name}`,
                    description: `Selecione exatamente ${combo.total_items_limit} itens.`,
                    options: combo.products,
                    onOpen: validator,
                    onSave: () => {
                        let finalPrice = parseFloat(combo.price);
                        let selected_items = [];
                        for (const [id, quantity] of Object.entries(selectedQuantities)) {
                            if (quantity > 0) {
                                const product = combo.products.find(p => p.id == id);
                                finalPrice += parseFloat(product.price_modifier) * quantity;
                                selected_items.push({ id: product.id, name: `${quantity}x ${product.name}` });
                            }
                        }
                        addToCart({
                            id: `combo_${combo.id}_${Date.now()}`,
                            name: combo.name,
                            price: finalPrice,
                            is_combo: true,
                            selected_items: selected_items
                        });
                        dom.modal.style.display = 'none';
                    }
                });

                dom.modalBody.querySelectorAll('.quantity-control button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const currentTotal = Object.values(selectedQuantities).reduce((s, q) => s + q, 0);
                        if (e.target.textContent === '+' && currentTotal >= combo.total_items_limit) return;
                        handleQuantityChange(e.target, selectedQuantities, validator);
                    });
                });
            };

            const fetchInitialData = async () => {
                try {
                    const [products, combos, settings] = await Promise.all([
                        fetch(`${API_BASE_URL}/api/public/products`).then(res => res.json()),
                        fetch(`${API_BASE_URL}/api/public/combos`).then(res => res.json()),
                        fetch(`${API_BASE_URL}/api/public/settings`).then(res => res.json())
                    ]);
                    
                    const mainProducts = products.filter(p => p.status);
                    const activeCombos = combos.filter(c => c.status).map(c => ({...c, is_combo: true}));
                    
                    allItems = [...activeCombos, ...mainProducts];
                    updateStoreStatus(settings);

                } catch (error) {
                    console.error("Falha ao buscar dados iniciais:", error);
                    dom.storeStatusBanner.style.display = 'block';
                    dom.storeStatusBanner.textContent = 'Não foi possível carregar o cardápio. Tente novamente mais tarde.';
                }
            };

            dom.orderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                dom.submitOrderBtn.disabled = true;
                dom.submitOrderBtn.textContent = 'A enviar...';

                const orderData = {
                    client_name: document.getElementById('client-name').value,
                    client_phone: document.getElementById('client-phone').value,
                    client_address: document.getElementById('client-address').value,
                    items: cart,
                    total_price: cart.reduce((acc, item) => acc + (item.price * item.quantity), 0) + (parseFloat(storeSettings.delivery_fee) || 0)
                };
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/public/orders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Houve um problema ao enviar o seu pedido.');
                    }
                    
                    dom.cartWrapper.style.display = 'none';
                    dom.successMessage.style.display = 'block';
                    cart = [];
                    dom.orderForm.reset();

                } catch (error) {
                    console.error('Erro ao finalizar pedido:', error);
                    alert(`Desculpe, não foi possível enviar seu pedido. Erro: ${error.message}`);
                    dom.submitOrderBtn.disabled = false;
                    dom.submitOrderBtn.textContent = 'Finalizar Pedido';
                }
            });

            const socket = io(API_BASE_URL);
            socket.on('settings_updated', (newSettings) => {
                console.log('Configurações atualizadas recebidas via Socket.IO!');
                updateStoreStatus(newSettings);
            });

            fetchInitialData();
        });
    </script>
</body>
</html>
