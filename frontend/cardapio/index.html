<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio - Pamonharia Sabor do Goiás</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-center">
                <h1 id="store-name-header">Pamonharia Sabor do Goiás</h1>
                <p>O verdadeiro sabor da fazenda, direto para a sua mesa!</p>
            </div>
            <button id="theme-switcher" class="theme-switcher" title="Alterar tema">
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
        </header>

        <div id="store-status-banner"></div>

        <div class="content-wrapper">
            <main>
                <div id="combos-section" style="display: none;">
                    <h2 class="section-title">Nossos Combos</h2>
                    <div id="combos-grid" class="items-grid"></div>
                </div>
                <hr id="section-divider" style="margin: 40px 0; border: 1px solid var(--border-color); display: none;">
                <div id="products-section" style="display: none;">
                    <h2 class="section-title">Produtos Individuais</h2>
                    <div id="products-grid" class="items-grid"></div>
                </div>
            </main>
            <aside>
                <div id="cart-wrapper" class="cart-container">
                    <div class="cart-header">
                        <h2>Meu Carrinho</h2>
                        <button id="clear-cart-btn" style="display: none;">Limpar Tudo</button>
                    </div>
                    <div id="cart-items">
                        <p id="empty-cart-msg">Seu carrinho está vazio.</p>
                    </div>
                    <div class="cart-totals">
                        <div class="total-row"><span>Subtotal</span><span id="subtotal">R$ 0,00</span></div>
                        <div class="total-row" id="delivery-fee-row"><span>Taxa de Entrega</span><span id="delivery-fee">R$ 0,00</span></div>
                        <div class="total-row grand-total"><span>Total</span><span id="grand-total">R$ 0,00</span></div>
                    </div>
                    
                    <div class="checkout-container">
                        <form id="order-form">
                            <h3>Finalizar Pedido</h3>
                            <div class="form-group"><label for="client-name">Nome</label><input type="text" id="client-name" required></div>
                            <div class="form-group"><label for="client-phone">Contacto (WhatsApp)</label><input type="tel" id="client-phone" required></div>
                            <div class="delivery-options"><label><input type="radio" name="delivery-type" value="delivery" checked> Entrega</label><label><input type="radio" name="delivery-type" value="pickup"> Retirada</label></div>
                            <div class="form-group" id="address-group"><label for="client-address">Endereço de Entrega</label><input type="text" id="client-address" required></div>
                            <div class="payment-options">
                                <p>Forma de Pagamento:</p>
                                <label><input type="radio" name="payment-method" value="on_delivery" checked> Pagar na Entrega/Retirada</label>
                                <label><input type="radio" name="payment-method" value="online"> Pagar Online (Pix ou Cartão)</label>
                            </div>
                            <button type="submit" class="action-button" id="submit-order" disabled>Finalizar Pedido</button>
                        </form>

                        <div id="payment-brick-container" style="display: none;"></div>
                        <div id="pix-payment-container" style="display: none;">
                            <h4>Pague com Pix para confirmar seu pedido</h4>
                            <p>Abra o app do seu banco e escaneie o código abaixo:</p>
                            <img id="pix-qr-code" src="" alt="Código QR do Pix">
                            <input type="text" id="pix-copy-paste" readonly>
                            <button id="pix-copy-btn" class="action-button">Copiar Código</button>
                            <p class="pix-expiration">Este código expira em 30 minutos.</p>
                        </div>
                        
                        <div id="payment-processing-overlay" style="display: none;">
                            <div class="spinner"></div>
                            <p>A processar pagamento...</p>
                        </div>
                    </div>
                </div>
                <div id="order-success-message" style="display: none;"><h3>Obrigado pelo seu pedido!</h3><p>Ele já foi enviado para a nossa cozinha e em breve chegará até você.</p></div>
                <div id="payment-status-message" style="display: none;"><h3>Status do Pagamento</h3><p id="payment-status-text"></p><button class="action-button" onclick="window.location.href='/cardapio'">Voltar ao Cardápio</button></div>
            </aside>
        </div>
    </div>

    <div id="selection-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close-btn">&times;</button><div id="modal-header" class="modal-header"></div><div id="modal-body" class="modal-body"></div><div class="modal-footer"><div id="modal-feedback" class="modal-feedback"></div><button id="add-to-cart-btn" class="action-button">Adicionar ao Carrinho</button></div></div></div>
    
    <div id="error-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="document.getElementById('error-modal').style.display='none'">&times;</button>
            <div id="error-modal-header" class="modal-header" style="color: var(--danger-color);">
                <h3 id="error-modal-title">Ocorreu um Erro</h3>
            </div>
            <div id="error-modal-body" class="modal-body" style="text-align: center;">
                <p id="error-modal-message"></p>
            </div>
            <div class="modal-footer">
                <button onclick="document.getElementById('error-modal').style.display='none'" class="action-button" style="background-color: var(--danger-color);">Fechar</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'http://localhost:10000';
            const socket = io(API_BASE_URL);

            let mp;

            const dom = {
                productsGrid: document.getElementById('products-grid'),
                combosGrid: document.getElementById('combos-grid'),
                cartItemsContainer: document.getElementById('cart-items'),
                subtotalEl: document.getElementById('subtotal'),
                deliveryFeeEl: document.getElementById('delivery-fee'),
                grandTotalEl: document.getElementById('grand-total'),
                orderForm: document.getElementById('order-form'),
                submitOrderBtn: document.getElementById('submit-order'),
                cartWrapper: document.getElementById('cart-wrapper'),
                successMessage: document.getElementById('order-success-message'),
                paymentStatusMessage: document.getElementById('payment-status-message'),
                paymentStatusText: document.getElementById('payment-status-text'),
                storeStatusBanner: document.getElementById('store-status-banner'),
                modal: document.getElementById('selection-modal'),
                modalHeader: document.getElementById('modal-header'),
                modalBody: document.getElementById('modal-body'),
                modalFeedback: document.getElementById('modal-feedback'),
                addToCartBtn: document.getElementById('add-to-cart-btn'),
                clearCartBtn: document.getElementById('clear-cart-btn'),
                addressGroup: document.getElementById('address-group'),
                clientAddressInput: document.getElementById('client-address'),
                deliveryFeeRow: document.getElementById('delivery-fee-row'),
                storeNameHeader: document.getElementById('store-name-header'),
                themeSwitcher: document.getElementById('theme-switcher'),
                errorModal: document.getElementById('error-modal'),
                errorModalTitle: document.getElementById('error-modal-title'),
                errorModalMessage: document.getElementById('error-modal-message'),
                paymentBrickContainer: document.getElementById('payment-brick-container'),
                pixPaymentContainer: document.getElementById('pix-payment-container'),
                pixQrCode: document.getElementById('pix-qr-code'),
                pixCopyPaste: document.getElementById('pix-copy-paste'),
                pixCopyBtn: document.getElementById('pix-copy-btn'),
                paymentProcessingOverlay: document.getElementById('payment-processing-overlay'),
            };

            let cart = [];
            let allItems = []; 
            let allProductsFlat = [];
            let productParentMap = {};
            let storeSettings = {};
            let liveStockState = {};
            let currentOrder = null;

            const showErrorModal = (title, message) => {
                dom.errorModalTitle.textContent = title;
                dom.errorModalMessage.textContent = message;
                dom.errorModal.style.display = 'flex';
            };

            const apiFetch = async (endpoint, options = {}) => {
                try {
                    options.headers = { ...options.headers, 'Content-Type': 'application/json' };
                    const response = await fetch(`${API_BASE_URL}/api${endpoint}`, options);
                    
                    const responseBodyText = await response.text();

                    if (!response.ok) {
                        let errorJson = {};
                        try {
                            errorJson = JSON.parse(responseBodyText);
                        } catch (e) {
                            throw new Error(responseBodyText || `HTTP error! status: ${response.status}`);
                        }
                        throw new Error(errorJson.error || `HTTP error! status: ${response.status}`);
                    }

                    return responseBodyText ? JSON.parse(responseBodyText) : null;
                } catch (error) {
                    console.error(`Erro de API para ${endpoint}:`, error);
                    throw error;
                }
            };

            const checkPaymentStatusFromURL = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const status = urlParams.get('status');
                const orderId = urlParams.get('order_id');

                if (status && orderId) {
                    dom.cartWrapper.style.display = 'none';
                    dom.successMessage.style.display = 'none';
                    dom.paymentStatusMessage.style.display = 'block';
                    let message = '';
                    switch (status) {
                        case 'success': message = `Pagamento para o pedido #${orderId} foi aprovado com sucesso! Já estamos a preparar tudo.`; break;
                        case 'failure': message = `O pagamento para o pedido #${orderId} falhou. Por favor, tente novamente ou escolha outra forma de pagamento.`; break;
                        case 'pending': message = `O pagamento para o pedido #${orderId} está pendente. Avisaremos assim que for aprovado.`; break;
                    }
                    dom.paymentStatusText.textContent = message;
                    window.history.replaceState({}, document.title, "/cardapio");
                }
            };

            dom.orderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
                
                dom.submitOrderBtn.disabled = true;
                dom.submitOrderBtn.textContent = 'A processar...';

                const deliveryType = document.querySelector('input[name="delivery-type"]:checked').value;
                const address = deliveryType === 'delivery' ? dom.clientAddressInput.value : 'Retirada no local';
                
                const itemsForBackend = cart.map(itemGroup => ({
                    id: itemGroup.original_id,
                    name: itemGroup.name,
                    price: itemGroup.price,
                    quantity: itemGroup.quantity,
                    is_combo: !!itemGroup.is_combo,
                    item_details: itemGroup.selected_items || []
                }));

                const orderData = {
                    client_name: document.getElementById('client-name').value,
                    client_phone: document.getElementById('client-phone').value,
                    client_address: address,
                    items: itemsForBackend,
                    total_price: parseFloat(dom.grandTotalEl.textContent.replace('R$ ', '').replace(',', '.')),
                    payment_method: paymentMethod
                };

                try {
                    currentOrder = await apiFetch('/public/orders', { method: 'POST', body: JSON.stringify(orderData) });
                    
                    if (paymentMethod === 'online') {
                        dom.orderForm.style.display = 'none';
                        dom.paymentProcessingOverlay.style.display = 'flex';
                        await initializePaymentBrick();
                    } else {
                        dom.cartWrapper.style.display = 'none';
                        dom.successMessage.style.display = 'block';
                        cart = [];
                        localStorage.removeItem('pamonharia-cart');
                    }
                } catch (error) {
                    showErrorModal('Falha no Pedido', `Não foi possível criar seu pedido. Detalhe: ${error.message}`);
                    dom.submitOrderBtn.disabled = false;
                    dom.submitOrderBtn.textContent = 'Finalizar Pedido';
                }
            });
            
            // #################### INÍCIO DA CORREÇÃO ####################
            async function initializePaymentBrick() {
                if (!mp) {
                    showErrorModal('Erro de Configuração', 'Não foi possível carregar as configurações de pagamento.');
                    return;
                }

                if (window.paymentBrickController) {
                    window.paymentBrickController.unmount();
                }

                const settings = {
                    initialization: {
                        amount: currentOrder.total_price,
                    },
                    customization: {
                        paymentMethods: {
                            // Habilita os métodos de pagamento desejados
                            creditCard: "all",
                            debitCard: "all",
                            pix: "all", // Garante que o Pix seja habilitado
                            // Removemos 'ticket' para desabilitar o boleto
                        },
                        visual: {
                           style: {
                                theme: document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'
                           },
                           hideInstallments: true // Oculta a informação de parcelamento
                        }
                    },
                    callbacks: {
                        onReady: () => {
                            console.log('✅ Payment Brick está pronto.');
                            dom.paymentProcessingOverlay.style.display = 'none';
                            dom.paymentBrickContainer.style.display = 'block';
                        },
                        onError: (error) => {
                            console.error('❌ Erro no Payment Brick:', error);
                            showErrorModal('Erro de Pagamento', 'Erro ao carregar opções de pagamento. Tente novamente.');
                            dom.paymentProcessingOverlay.style.display = 'none';
                            dom.orderForm.style.display = 'block';
                        },
                        onSubmit: async ({ selectedPaymentMethod, formData }) => {
                            dom.paymentBrickContainer.style.display = 'none';
                            dom.paymentProcessingOverlay.style.display = 'flex';

                            try {
                                const paymentData = {
                                    order_id: currentOrder.id,
                                    payment_method_id: selectedPaymentMethod,
                                    payer: {
                                        email: formData.payer.email,
                                        firstName: formData.payer.firstName,
                                        lastName: formData.payer.lastName,
                                        identification: formData.payer.identification,
                                    }
                                };
                                
                                // Adiciona dados de cartão apenas se o método não for Pix
                                if (selectedPaymentMethod !== 'pix') {
                                    paymentData.token = formData.token;
                                    paymentData.installments = formData.installments;
                                    paymentData.issuer_id = formData.issuer_id;
                                }

                                const paymentResponse = await apiFetch('/payments/process', {
                                    method: 'POST',
                                    body: JSON.stringify(paymentData)
                                });

                                dom.paymentProcessingOverlay.style.display = 'none';

                                if (selectedPaymentMethod === 'pix') {
                                    dom.pixQrCode.src = `data:image/jpeg;base64,${paymentResponse.qr_code_base64}`;
                                    dom.pixCopyPaste.value = paymentResponse.qr_code;
                                    dom.pixPaymentContainer.style.display = 'block';
                                } else {
                                    dom.cartWrapper.style.display = 'none';
                                    dom.successMessage.style.display = 'block';
                                    dom.successMessage.innerHTML = `<h3>Pagamento Aprovado!</h3><p>Pedido #${currentOrder.id} confirmado e em preparo.</p>`;
                                }

                                cart = [];
                                localStorage.removeItem('pamonharia-cart');

                            } catch (error) {
                                dom.paymentProcessingOverlay.style.display = 'none';
                                showErrorModal('Pagamento Falhou', `Erro ao processar o pagamento. Detalhe: ${error.message}`);
                                dom.paymentBrickContainer.style.display = 'block';
                            }
                        }
                    }
                };

                window.paymentBrickController = await mp.bricks().create('payment', 'payment-brick-container', settings);
            }
            // ##################### FIM DA CORREÇÃO ######################


            dom.pixCopyBtn.addEventListener('click', () => {
                dom.pixCopyPaste.select();
                document.execCommand('copy');
                dom.pixCopyBtn.textContent = 'Copiado!';
                setTimeout(() => { dom.pixCopyBtn.textContent = 'Copiar Código'; }, 2000);
            });

            const calculateTotals = () => {
                let subtotal = 0;
                cart.forEach(itemGroup => {
                    subtotal += (itemGroup.total_value || 0);
                });

                const isDelivery = document.querySelector('input[name="delivery-type"]:checked').value === 'delivery';
                const deliveryFee = isDelivery && subtotal > 0 ? parseFloat(storeSettings.delivery_fee || 0) : 0;
                dom.deliveryFeeRow.style.display = isDelivery ? 'flex' : 'none';
                const grandTotal = subtotal + deliveryFee;

                dom.subtotalEl.textContent = `R$ ${subtotal.toFixed(2).replace('.',',')}`;
                dom.deliveryFeeEl.textContent = `R$ ${deliveryFee.toFixed(2).replace('.',',')}`;
                dom.grandTotalEl.textContent = `R$ ${grandTotal.toFixed(2).replace('.',',')}`;
            };

            const renderCart = () => {
                localStorage.setItem('pamonharia-cart', JSON.stringify(cart));
                calculateTotals();

                dom.clearCartBtn.style.display = cart.length > 0 ? 'inline-block' : 'none';
                if (cart.length === 0) {
                    dom.cartItemsContainer.innerHTML = '<p id="empty-cart-msg">Seu carrinho está vazio.</p>';
                    dom.submitOrderBtn.disabled = true;
                    return;
                }

                dom.cartItemsContainer.innerHTML = '';
                cart.forEach((itemGroup, cartIndex) => {
                    const originalProduct = allItems.find(p => p.id === itemGroup.original_id);
                    const isLockedGroup = itemGroup.is_combo || (originalProduct && originalProduct.force_one_to_one_complement);
                    
                    let subItemsHtml = '';
                    if (itemGroup.selected_items && itemGroup.selected_items.length > 0) {
                        subItemsHtml = '<div class="cart-sub-items">';
                        
                        if (!isLockedGroup) {
                            subItemsHtml += itemGroup.selected_items.map((subItem, subItemIndex) => {
                                return `<div class="cart-sub-item">
                                            <span>${subItem.name}</span>
                                            <div class="quantity-control-cart">
                                                <button onclick="adjustCartItemQuantity(${cartIndex}, ${subItemIndex}, -1)">-</button>
                                                <span>${subItem.quantity}</span>
                                                <button onclick="adjustCartItemQuantity(${cartIndex}, ${subItemIndex}, 1)">+</button>
                                            </div>
                                        </div>`;
                            }).join('');
                        } else {
                            const complementCounts = {};
                            itemGroup.selected_items.forEach(sub => {
                                complementCounts[sub.name] = (complementCounts[sub.name] || 0) + sub.quantity;
                            });
                             subItemsHtml += Object.entries(complementCounts).map(([name, count]) => {
                                return `<div class="cart-sub-item"><span>${count * itemGroup.quantity}x ${name}</span></div>`;
                            }).join('');
                        }

                        subItemsHtml += '</div>';
                    }
                    
                    let mainControlsHtml = '';
                    if (isLockedGroup) {
                         mainControlsHtml = `<div class="quantity-control-cart"><button onclick="adjustCartItemGroupQuantity(${cartIndex}, -1)">-</button><span>${itemGroup.quantity}</span><button onclick="adjustCartItemGroupQuantity(${cartIndex}, 1)">+</button></div>`;
                    } else {
                        mainControlsHtml = `<div class="quantity-control-cart" style="visibility: hidden;"></div>`;
                    }

                    dom.cartItemsContainer.innerHTML += `
                        <div class="cart-item-group" data-cart-id="${itemGroup.cart_id}">
                            <div class="cart-main-item">
                                <img src="${itemGroup.image_url || 'https://placehold.co/60x60/f59e0b/FFF?text=Item'}" alt="${itemGroup.name}" class="cart-item-image">
                                <div class="cart-item-info">
                                    <strong>${itemGroup.name}</strong>
                                    <span class="cart-item-price">R$ ${(itemGroup.total_value || 0).toFixed(2).replace('.',',')}</span>
                                </div>
                                <div class="cart-main-controls">
                                    ${mainControlsHtml}
                                    <button class="remove-item-btn" onclick="removeCartItemGroup(${cartIndex})">&times;</button>
                                </div>
                            </div>
                            ${subItemsHtml}
                        </div>
                    `;
                });
                dom.submitOrderBtn.disabled = !storeSettings.is_open;
            };
            
            window.adjustCartItemQuantity = (cartIndex, subItemIndex, amount) => {
                const itemGroup = cart[cartIndex];
                if (!itemGroup || !itemGroup.selected_items) return;

                const subItem = itemGroup.selected_items[subItemIndex];
                const stockCheckItem = allProductsFlat.find(p => p.id === subItem.id);
                if (!subItem || !stockCheckItem) return;

                const newQuantity = subItem.quantity + amount;

                if (amount > 0) {
                    if (getAvailableStock(stockCheckItem) < 1) {
                        showErrorModal('Item Esgotado', `Desculpe, ${stockCheckItem.name} está esgotado.`);
                        return;
                    }
                    socket.emit('reserve_stock', [{ id: stockCheckItem.id, quantity: 1 }]);
                } else if (amount < 0 && subItem.quantity > 0) {
                    socket.emit('release_stock', [{ id: stockCheckItem.id, quantity: 1 }]);
                }

                if (newQuantity <= 0) {
                    itemGroup.selected_items.splice(subItemIndex, 1);
                } else {
                    subItem.quantity = newQuantity;
                }
                
                let newTotalValue = 0;
                const parentProduct = allItems.find(p => p.id === itemGroup.original_id);
                if (parentProduct && parentProduct.sell_parent_product) {
                    const parentQuantity = itemGroup.selected_items.reduce((sum, si) => sum + si.quantity, 0);
                    newTotalValue += parseFloat(parentProduct.price) * parentQuantity;
                }
                itemGroup.selected_items.forEach(si => {
                    newTotalValue += parseFloat(si.price) * si.quantity;
                });
                itemGroup.total_value = newTotalValue;

                if (itemGroup.selected_items.length === 0 && !(parentProduct && parentProduct.sell_parent_product)) {
                    removeCartItemGroup(cartIndex);
                } else {
                    renderCart();
                }
            };

            window.adjustCartItemGroupQuantity = (cartIndex, amount) => {
                const itemGroup = cart[cartIndex];
                if (!itemGroup) return;

                const originalProduct = allItems.find(p => p.id === itemGroup.original_id);
                const newQuantity = itemGroup.quantity + amount;

                if (newQuantity <= 0) {
                    removeCartItemGroup(cartIndex);
                    return;
                }

                if (originalProduct && originalProduct.force_one_to_one_complement) {
                    if (amount < 0) {
                        if (itemGroup.selected_items.length > 0) {
                            const complementToRemove = itemGroup.selected_items.pop();
                            if (complementToRemove) {
                                socket.emit('release_stock', [{ id: complementToRemove.id, quantity: 1 }]);
                            }
                            itemGroup.quantity = newQuantity;
                            itemGroup.total_value = itemGroup.price * newQuantity;
                        }
                    } else { 
                        showErrorModal('Ação Indisponível', 'Para adicionar mais itens com complementos obrigatórios, por favor, use o botão "Montar" no cardápio.');
                        return;
                    }
                } else { 
                    let itemsToUpdate = [];
                    if (itemGroup.selected_items && itemGroup.selected_items.length > 0) {
                        itemGroup.selected_items.forEach(sub => {
                            const baseQuantity = sub.quantity;
                            itemsToUpdate.push({ id: sub.id, quantity: baseQuantity });
                        });
                    } else if (!itemGroup.is_combo) {
                        itemsToUpdate.push({ id: itemGroup.original_id, quantity: 1 });
                    }
                    
                    if (amount > 0) {
                        for (const item of itemsToUpdate) {
                            const stockCheckItem = allProductsFlat.find(p => p.id === item.id);
                            if (getAvailableStock(stockCheckItem) < item.quantity) {
                                showErrorModal('Estoque Insuficiente', `Não há estoque suficiente para adicionar mais um "${itemGroup.name}".`);
                                return;
                            }
                        }
                        socket.emit('reserve_stock', itemsToUpdate);
                    } else {
                        socket.emit('release_stock', itemsToUpdate);
                    }
                    itemGroup.quantity = newQuantity;
                    itemGroup.total_value = itemGroup.price * newQuantity;
                }
                renderCart();
            };
            
            window.removeCartItemGroup = (cartIndex) => {
                const itemToRemove = cart[cartIndex];
                if (!itemToRemove) return;

                let itemsToRelease = [];
                if (itemToRemove.is_combo || (allItems.find(p => p.id === itemToRemove.original_id) && allItems.find(p => p.id === itemToRemove.original_id).force_one_to_one_complement)) {
                    if (itemToRemove.selected_items && itemToRemove.selected_items.length > 0) {
                         itemToRemove.selected_items.forEach(sub => {
                            itemsToRelease.push({ id: sub.id, quantity: sub.quantity * itemToRemove.quantity });
                        });
                    }
                } else { 
                     if (itemToRemove.selected_items && itemToRemove.selected_items.length > 0) {
                        itemsToRelease.push(...itemToRemove.selected_items.map(sub => ({ id: sub.id, quantity: sub.quantity })));
                    }
                }
                
                const parentProduct = allItems.find(p => p.id === itemToRemove.original_id);
                if (parentProduct && (parentProduct.sell_parent_product || (itemToRemove.selected_items && itemToRemove.selected_items.length === 0))) {
                     itemsToRelease.push({ id: itemToRemove.original_id, quantity: itemToRemove.quantity });
                }

                socket.emit('release_stock', itemsToRelease.filter(i => i.id && i.quantity > 0));
                cart.splice(cartIndex, 1);
                renderCart();
            };

            dom.clearCartBtn.addEventListener('click', () => {
                if (cart.length === 0) return;
                const allItemsToRelease = cart.flatMap(itemGroup => {
                    let items = [];
                    const parentProduct = allItems.find(p => p.id === itemGroup.original_id);
                    if (itemGroup.selected_items && itemGroup.selected_items.length > 0) {
                        const multiplier = (itemGroup.is_combo || (parentProduct && parentProduct.force_one_to_one_complement)) ? itemGroup.quantity : 1;
                        items = itemGroup.selected_items.map(sub => ({ id: sub.id, quantity: sub.quantity * multiplier }));
                    }
                     if (parentProduct && (parentProduct.sell_parent_product || (itemGroup.selected_items && itemGroup.selected_items.length === 0))) {
                        items.push({ id: itemGroup.original_id, quantity: itemGroup.quantity });
                    }
                    return items;
                }).filter(i => i && i.id && i.quantity > 0);

                socket.emit('release_stock', allItemsToRelease);
                cart = [];
                renderCart();
            });
            
            const applyTheme = (theme) => { 
                document.body.setAttribute('data-theme', theme); 
                localStorage.setItem('pamonharia-theme', theme); 
                if (window.paymentBrickController) {
                    window.paymentBrickController.update({ customization: { visual: { style: { theme: theme === 'dark' ? 'dark' : 'default' } } } });
                }
            };
            
            const getAvailableStock = (item) => {
                if (!item) return 0;
                const parentId = productParentMap[item.id];
                if (parentId) {
                    const parent = allProductsFlat.find(p => p.id === parentId);
                    if (parent && parent.stock_sync_enabled && parent.stock_enabled) { return liveStockState[parent.id] || 0; }
                }
                if (item.stock_enabled) { return liveStockState[item.id] || 0; }
                return Infinity;
            };
            
            const isItemEffectivelyOutOfStock = (item) => {
                if (!item) return true;
                const parentStock = getAvailableStock(item);
                if (item.force_one_to_one_complement) {
                    return parentStock <= 0;
                }
                const hasChildren = item.children && item.children.length > 0;
                const childrenOutOfStock = hasChildren && item.children.every(child => {
                    const childData = allProductsFlat.find(p => p.id === child.id);
                    return getAvailableStock(childData) <= 0;
                });
                if (hasChildren && !item.sell_parent_product) {
                    return childrenOutOfStock;
                }
                return parentStock <= 0;
            };

            const isComboEffectivelyOutOfStock = (combo) => {
                if (!combo || !combo.products) return true;
                const totalAvailableStock = combo.products.reduce((sum, product) => sum + getAvailableStock(allProductsFlat.find(p => p.id === product.id)), 0);
                return totalAvailableStock < combo.total_items_limit;
            };

            const fetchAndRenderAll = async () => {
                try {
                    const paymentSettings = await apiFetch('/public/payment-settings');
                    mp = new MercadoPago(paymentSettings.mercadoPagoPublicKey);

                    const [productsResponse, combosResponse, settingsResponse] = await Promise.all([ 
                        apiFetch('/public/products'),
                        apiFetch('/public/combos'),
                        apiFetch('/public/settings') 
                    ]);
                    storeSettings = settingsResponse;
                    allProductsFlat = [];
                    productParentMap = {};
                    const recursiveFlattenAndMap = (products, parent = null) => {
                        if (!products) return;
                        products.forEach(p => {
                            allProductsFlat.push(p);
                            if (parent) productParentMap[p.id] = parent.id;
                            if (p.children && p.children.length > 0) recursiveFlattenAndMap(p.children, p);
                        });
                    };
                    recursiveFlattenAndMap(productsResponse);
                    combosResponse.forEach(c => { if (c.products) c.products = c.products.map(p => allProductsFlat.find(i => i.id === p.id) || p); });
                    allItems = [...combosResponse.map(c => ({...c, is_combo: true})), ...productsResponse];
                    
                    const savedCart = localStorage.getItem('pamonharia-cart');
                    if(savedCart) cart = JSON.parse(savedCart);

                    updateStoreStatus();
                    renderItems();
                    renderCart();
                } catch (error) { 
                    console.error("Erro fatal ao carregar dados:", error);
                    document.body.innerHTML = `<h1>Erro ao carregar o cardápio. Verifique a configuração do servidor.</h1><p><small>${error.message}</small></p>`; 
                }
            };

            const renderItems = () => {
                dom.productsGrid.innerHTML = '';
                dom.combosGrid.innerHTML = '';
                const activeProducts = allItems.filter(item => !item.is_combo && item.is_main_product);
                const activeCombos = allItems.filter(item => item.is_combo);
                document.getElementById('products-section').style.display = activeProducts.length > 0 ? 'block' : 'none';
                document.getElementById('combos-section').style.display = activeCombos.length > 0 ? 'block' : 'none';
                document.getElementById('section-divider').style.display = activeProducts.length > 0 && activeCombos.length > 0 ? 'block' : 'none';
                allItems.forEach(item => {
                    if (!item.status) return;
                    const grid = item.is_combo ? dom.combosGrid : dom.productsGrid;
                    if (!grid || (!item.is_main_product && !item.is_combo)) return;
                    let priceText;
                    if (item.is_combo) { priceText = `A partir de R$ ${parseFloat(item.price).toFixed(2).replace('.',',')}`; }
                    else if (item.children && item.children.length > 0 && !item.sell_parent_product) {
                        const availableChildren = item.children.filter(c => !isItemEffectivelyOutOfStock(allProductsFlat.find(p => p.id === c.id)));
                        if (availableChildren.length > 0) {
                            const minPrice = Math.min(...availableChildren.map(c => c.price));
                            priceText = `A partir de R$ ${parseFloat(minPrice).toFixed(2).replace('.',',')}`;
                        } else { priceText = 'Opções esgotadas'; }
                    } else { priceText = `R$ ${parseFloat(item.price).toFixed(2).replace('.',',')}`; }
                    const hasOptions = (item.children && item.children.length > 0) || (item.is_combo);
                    const isOutOfStock = item.is_combo ? isComboEffectivelyOutOfStock(item) : isItemEffectivelyOutOfStock(item);
                    const onClickAction = item.is_combo ? `openComboModal(${item.id})` : (hasOptions ? `openProductWithOptionsModal(${item.id})` : `addToCartSimple(${item.id})`);
                    grid.innerHTML += `<div class="item-card ${isOutOfStock ? 'out-of-stock' : ''}" data-id="${item.id}"><div class="stock-overlay">${isOutOfStock ? 'Esgotado' : ''}</div><img src="${item.image_url || 'https://placehold.co/400x250/f59e0b/FFF?text=Pamonha'}" alt="${item.name}" class="item-image"><div class="item-info"><h3>${item.name}</h3><p class="description">${item.description || ''}</p><div class="item-price">${priceText}</div><button class="action-button" onclick="${onClickAction}" ${!storeSettings.is_open || isOutOfStock ? 'disabled' : ''}>${hasOptions ? 'Montar' : 'Adicionar'}</button></div></div>`;
                });
            };

            const updateStoreStatus = () => {
                const now = new Date();
                const dayOfWeek = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'][now.getDay()];
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                let isOpen = false;
                if (storeSettings.is_open_manual_override !== null) { isOpen = storeSettings.is_open_manual_override; }
                else {
                    const schedule = storeSettings.operating_hours?.[dayOfWeek];
                    if (schedule && schedule.enabled) { isOpen = currentTime >= schedule.open && currentTime <= schedule.close; }
                }
                storeSettings.is_open = isOpen;
                dom.storeStatusBanner.style.display = 'block';
                if (isOpen) { dom.storeStatusBanner.textContent = 'Loja Aberta! Faça seu pedido.'; dom.storeStatusBanner.className = 'open'; }
                else { dom.storeStatusBanner.textContent = 'Loja Fechada. Não estamos a aceitar pedidos no momento.'; dom.storeStatusBanner.className = 'closed'; }
                if(storeSettings.store_name) dom.storeNameHeader.textContent = storeSettings.store_name;
            };

            const handleQuantityChange = (target, state, validator, item, options = {}) => {
                const itemId = parseInt(target.dataset.itemId);
                const isIncrement = target.textContent === '+';
                
                if (isIncrement && options.isComplement && options.oneToOneRuleActive) {
                    const parentQty = options.getParentQty();
                    const totalComplements = options.getTotalComplementsQty();
                    if (totalComplements >= parentQty) {
                        dom.modalFeedback.textContent = `Limite de complementos atingido (${parentQty}).`;
                        setTimeout(() => dom.modalFeedback.textContent = '', 3000);
                        return;
                    }
                }

                if (isIncrement) {
                    const availableStock = getAvailableStock(item);
                    if (availableStock !== Infinity && (state[itemId] || 0) >= availableStock) {
                        dom.modalFeedback.textContent = `Limite de estoque para "${item.name}" atingido.`;
                        setTimeout(() => dom.modalFeedback.textContent = '', 3000);
                        return;
                    }
                    state[itemId] = (state[itemId] || 0) + 1;
                } else {
                    state[itemId] = Math.max(0, (state[itemId] || 0) - 1);
                }
                document.getElementById(`quantity-${itemId}`).textContent = state[itemId];
                if (validator) validator();
            };
            
            const addToCartAndReserve = (itemData, itemsToReserve) => {
                dom.addToCartBtn.disabled = true;
                dom.addToCartBtn.textContent = 'Reservando...';
                dom.modalFeedback.textContent = '';

                const successHandler = () => {
                    socket.off('reservation_failure', failureHandler); 
                    console.log('[Cart] Reserva confirmada pelo servidor. Adicionando ao carrinho.');
                    cart.push({ ...itemData, cart_id: `cart_${Date.now()}` });
                    renderCart();
                    dom.modal.style.display = 'none';
                    dom.addToCartBtn.disabled = false;
                    dom.addToCartBtn.textContent = 'Adicionar ao Carrinho';
                };

                const failureHandler = ({ message }) => {
                    socket.off('reservation_success', successHandler); 
                    console.error('[Cart] Falha na reserva:', message);
                    dom.modalFeedback.textContent = `Erro: ${message}`;
                    dom.addToCartBtn.disabled = false;
                    dom.addToCartBtn.textContent = 'Adicionar ao Carrinho';
                };

                socket.once('reservation_success', successHandler);
                socket.once('reservation_failure', failureHandler);
                socket.emit('reserve_stock', itemsToReserve);
            };

            window.addToCartSimple = (itemId) => {
                const item = allProductsFlat.find(p => p.id === itemId);
                if (!item || isItemEffectivelyOutOfStock(item)) return;
                const itemsToReserve = [{ id: item.id, quantity: 1 }];
                const itemData = { 
                    original_id: item.id, 
                    name: item.name, 
                    price: parseFloat(item.price), 
                    total_value: parseFloat(item.price),
                    image_url: item.image_url, 
                    quantity: 1, 
                    is_combo: false, 
                    selected_items: [] 
                };
                addToCartAndReserve(itemData, itemsToReserve);
            };

            const setupModal = (config) => {
                dom.modalHeader.innerHTML = `<h3>${config.title}</h3><p>${config.description}</p>`;
                dom.modalBody.innerHTML = config.body || '';
                dom.modalFeedback.textContent = '';
                dom.addToCartBtn.textContent = 'Adicionar ao Carrinho';
                dom.addToCartBtn.disabled = false;
                dom.addToCartBtn.onclick = config.onSave;
                dom.modal.querySelector('.modal-close-btn').onclick = () => dom.modal.style.display = 'none';
                dom.modal.style.display = 'flex';
                if(config.onOpen) config.onOpen();
            };

            window.openProductWithOptionsModal = (productId) => {
                const product = allItems.find(item => item.id === productId);
                if (!product) return;
                let selectedItemsInModal = {};
                let bodyHtml = '';
                
                if (product.sell_parent_product) {
                    const isParentOutOfStock = isItemEffectivelyOutOfStock(product);
                    const initialQty = product.force_one_to_one_complement ? 1 : 0;
                    selectedItemsInModal[product.id] = initialQty;
                    bodyHtml += `<div class="modal-parent-item"><span>${product.name} (Base)</span><div class="quantity-control"><button data-item-id="${product.id}" ${isParentOutOfStock ? 'disabled' : ''}>-</button><span id="quantity-${product.id}">${initialQty}</span><button data-item-id="${product.id}" ${isParentOutOfStock ? 'disabled' : ''}>+</button></div></div>`;
                }

                if (product.children && product.children.length > 0) {
                    bodyHtml += `<h4>${product.sell_parent_product ? 'Adicione complementos:' : 'Escolha os sabores:'}</h4>`;
                    product.children.forEach(option => {
                        const fullOptionData = allProductsFlat.find(p => p.id === option.id);
                        const isOptionOutOfStock = isItemEffectivelyOutOfStock(fullOptionData);
                        bodyHtml += `<div class="modal-item-option ${isOptionOutOfStock ? 'disabled' : ''}"><label>${option.name} (+ R$ ${parseFloat(option.price).toFixed(2).replace('.',',')})</label><div class="quantity-control"><button data-item-id="${option.id}" data-is-complement="true" ${isOptionOutOfStock ? 'disabled' : ''}>-</button><span id="quantity-${option.id}">0</span><button data-item-id="${option.id}" data-is-complement="true" ${isOptionOutOfStock ? 'disabled' : ''}>+</button></div></div>`;
                    });
                }
                
                const onSave = () => {
                    let selected_items_details = [], itemsToReserve = [];
                    let finalPrice = 0;
                    let finalQuantity = 1; 
                    
                    const parentQty = selectedItemsInModal[product.id] || 0;
                    if (product.sell_parent_product && parentQty > 0) {
                        const parentAsItem = { id: product.id, name: product.name, quantity: parentQty, price: product.price };
                        selected_items_details.push(parentAsItem);
                        itemsToReserve.push({ id: product.id, quantity: parentQty });
                        finalPrice += parseFloat(product.price || 0) * parentQty;
                    }

                    for (const [id, quantity] of Object.entries(selectedItemsInModal)) {
                        if (quantity > 0 && id != product.id) {
                            const selectedItem = allProductsFlat.find(i => i.id == id);
                            if (selectedItem) {
                                selected_items_details.push({ id: selectedItem.id, name: selectedItem.name, quantity: quantity, price: selectedItem.price });
                                finalPrice += parseFloat(selectedItem.price || 0) * quantity;
                                itemsToReserve.push({ id: selectedItem.id, quantity: quantity });
                            }
                        }
                    }

                    if (product.force_one_to_one_complement) {
                        finalPrice = selected_items_details.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
                        finalQuantity = parentQty; 
                    }
                    
                    const itemData = { 
                        original_id: product.id, 
                        name: product.name, 
                        price: finalQuantity > 0 ? (finalPrice / finalQuantity) : 0,
                        total_value: finalPrice,
                        quantity: finalQuantity, 
                        is_combo: false, 
                        selected_items: selected_items_details, 
                        image_url: product.image_url 
                    };
                    addToCartAndReserve(itemData, itemsToReserve);
                };

                const validator = () => {
                    const totalSelected = Object.values(selectedItemsInModal).reduce((sum, qty) => sum + qty, 0);
                    let isValid = totalSelected > 0;
                    let buttonText = 'Adicionar ao Carrinho';

                    if (product.force_one_to_one_complement) {
                        const parentQty = selectedItemsInModal[product.id] || 0;
                        const totalComplementsQty = Object.entries(selectedItemsInModal).filter(entry => entry[0] != product.id).reduce((sum, entry) => sum + entry[1], 0);
                        const diff = parentQty - totalComplementsQty;
                        
                        dom.modalFeedback.textContent = diff !== 0 ? `A seleção de complementos (${totalComplementsQty}) deve ser igual à do item principal (${parentQty}).` : '';
                        isValid = (parentQty === totalComplementsQty) && parentQty > 0;
                        if (isValid) buttonText = `Adicionar ${parentQty} item(ns)`;
                    }
                    
                    dom.addToCartBtn.textContent = buttonText;
                    dom.addToCartBtn.disabled = !isValid;
                };

                setupModal({ title: `Montar ${product.name}`, description: 'Selecione os itens e quantidades desejadas.', body: bodyHtml, onSave, onOpen: validator });
                dom.modalBody.querySelectorAll('.quantity-control button[data-item-id]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const optionId = e.target.dataset.itemId;
                        const option = allProductsFlat.find(i => i.id == optionId);
                        if (option) {
                            const changeOptions = { 
                                isComplement: e.target.dataset.isComplement === 'true', 
                                oneToOneRuleActive: product.force_one_to_one_complement, 
                                getParentQty: () => selectedItemsInModal[product.id] || 0, 
                                getTotalComplementsQty: () => Object.entries(selectedItemsInModal).filter(entry => entry[0] != product.id).reduce((sum, entry) => sum + entry[1], 0)
                            };
                            handleQuantityChange(e.target, selectedItemsInModal, validator, option, changeOptions);
                        }
                    });
                });
            };

            window.openComboModal = (comboId) => {
                const combo = allItems.find(item => item.id === comboId);
                if (!combo) return;
                let selectedQuantities = {}, comboBodyHtml = '';
                combo.products.forEach(option => {
                    const fullOptionData = allProductsFlat.find(p => p.id === option.id);
                    const isOptionOutOfStock = isItemEffectivelyOutOfStock(fullOptionData);
                    const priceModifierText = option.price_modifier > 0 ? `+ R$ ${parseFloat(option.price_modifier).toFixed(2).replace('.',',')}` : '';
                    comboBodyHtml += `<div class="modal-item-option ${isOptionOutOfStock ? 'disabled' : ''}"><label>${option.name} ${isOptionOutOfStock ? '<small>(Esgotado)</small>' : ''}</label><span class="price-modifier">${priceModifierText}</span><div class="quantity-control"><button data-item-id="${option.id}" ${isOptionOutOfStock ? 'disabled' : ''}>-</button><span id="quantity-${option.id}">0</span><button data-item-id="${option.id}" ${isOptionOutOfStock ? 'disabled' : ''}>+</button></div></div>`;
                });
                const validator = () => {
                    const totalSelected = Object.values(selectedQuantities).reduce((sum, qty) => sum + qty, 0);
                    const totalLimit = combo.total_items_limit;
                    dom.addToCartBtn.disabled = totalSelected !== totalLimit;
                    dom.modalFeedback.textContent = '';
                    if (totalSelected > totalLimit) {
                        dom.modalFeedback.textContent = `Limite de ${totalLimit} itens excedido.`;
                        dom.addToCartBtn.disabled = true;
                    }
                    dom.addToCartBtn.textContent = `Adicionar (${totalSelected}/${totalLimit}) ao Carrinho`;
                };
                const onSave = () => {
                    let finalPrice = parseFloat(combo.price), selected_items = [], itemsToReserve = [];
                    for (const [id, quantity] of Object.entries(selectedQuantities)) {
                        if (quantity > 0) {
                            const product = allProductsFlat.find(p => p.id == id);
                            const comboProductInfo = combo.products.find(p => p.id == id);
                            finalPrice += parseFloat(comboProductInfo.price_modifier || 0) * quantity;
                            selected_items.push({ id: product.id, name: product.name, quantity: quantity, price: product.price });
                            itemsToReserve.push({ id: product.id, quantity: quantity });
                        }
                    }
                    const itemData = { original_id: combo.id, name: combo.name, price: finalPrice, total_value: finalPrice, is_combo: true, quantity: 1, selected_items, image_url: combo.image_url };
                    addToCartAndReserve(itemData, itemsToReserve);
                };
                setupModal({ title: `Montar ${combo.name}`, description: `Selecione exatamente ${combo.total_items_limit} itens.`, body: comboBodyHtml, onSave, onOpen: validator });
                dom.modalBody.querySelectorAll('.quantity-control button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const totalLimit = combo.total_items_limit;
                        const currentTotal = Object.values(selectedQuantities).reduce((s, q) => s + q, 0);
                        if (e.target.textContent === '+' && currentTotal >= totalLimit) {
                             dom.modalFeedback.textContent = `Você já selecionou o limite de ${totalLimit} itens.`;
                             setTimeout(() => dom.modalFeedback.textContent = '', 2500);
                             return;
                        }
                        const optionId = e.target.dataset.itemId;
                        const option = allProductsFlat.find(p => p.id == optionId);
                        if(option) handleQuantityChange(e.target, selectedQuantities, validator, option);
                    });
                });
            };
            
            socket.on('connect', () => console.log('[Cardapio] ✅ Socket.IO conectado ao servidor.'));
            socket.on('stock_update', (inventory) => { liveStockState = inventory; renderItems(); });
            socket.on('data_updated', fetchAndRenderAll);
            dom.themeSwitcher.addEventListener('click', () => { const currentTheme = document.body.getAttribute('data-theme'); applyTheme(currentTheme === 'dark' ? 'light' : 'dark'); });
            document.querySelectorAll('input[name="delivery-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isDelivery = e.target.value === 'delivery';
                    dom.addressGroup.style.display = isDelivery ? 'block' : 'none';
                    dom.clientAddressInput.required = isDelivery;
                    calculateTotals();
                });
            });
            const savedTheme = localStorage.getItem('pamonharia-theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
            fetchAndRenderAll();
            checkPaymentStatusFromURL();
        });
    </script>
</body>
</html>
