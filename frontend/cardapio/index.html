<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio - Pamonharia Sabor do Goiás</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-center">
                <h1 id="store-name-header">Pamonharia Sabor do Goiás</h1>
                <p>O verdadeiro sabor da fazenda, direto para a sua mesa!</p>
            </div>
            <button id="theme-switcher" class="theme-switcher" title="Alterar tema">
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
        </header>

        <div id="store-status-banner"></div>

        <div class="content-wrapper">
            <main>
                <div id="combos-section" style="display: none;">
                    <h2 class="section-title">Nossos Combos</h2>
                    <div id="combos-grid" class="items-grid"></div>
                </div>
                <hr id="section-divider" style="margin: 40px 0; border: 1px solid var(--border-color); display: none;">
                <div id="products-section" style="display: none;">
                    <h2 class="section-title">Produtos Individuais</h2>
                    <div id="products-grid" class="items-grid"></div>
                </div>
            </main>
            <aside>
                <div id="cart-wrapper" class="cart-container">
                    <div class="cart-header">
                        <h2>Meu Carrinho</h2>
                        <button id="clear-cart-btn" style="display: none;">Limpar</button>
                    </div>
                    <div id="cart-items">
                        <p id="empty-cart-msg">Seu carrinho está vazio.</p>
                    </div>
                    <div class="cart-totals">
                        <div class="total-row"><span>Subtotal</span><span id="subtotal">R$ 0,00</span></div>
                        <div class="total-row" id="delivery-fee-row"><span>Taxa de Entrega</span><span id="delivery-fee">R$ 0,00</span></div>
                        <div class="total-row grand-total"><span>Total</span><span id="grand-total">R$ 0,00</span></div>
                    </div>
                    <div class="checkout-form">
                        <h3>Finalizar Pedido</h3>
                        <form id="order-form">
                            <div class="form-group">
                                <label for="client-name">Nome</label>
                                <input type="text" id="client-name" required>
                            </div>
                            <div class="form-group">
                                <label for="client-phone">Contacto (WhatsApp)</label>
                                <input type="tel" id="client-phone" required>
                            </div>
                            
                            <div class="delivery-options">
                                <label><input type="radio" name="delivery-type" value="delivery" checked> Entrega</label>
                                <label><input type="radio" name="delivery-type" value="pickup"> Retirada</label>
                            </div>

                            <div class="form-group" id="address-group">
                                <label for="client-address">Endereço de Entrega</label>
                                <input type="text" id="client-address" required>
                            </div>

                            <div class="payment-options">
                                <p>Forma de Pagamento:</p>
                                <label><input type="radio" name="payment-method" value="on_delivery" checked> Pagar na Entrega/Retirada</label>
                                <label><input type="radio" name="payment-method" value="online" disabled> Pagar Online (Em breve)</label>
                            </div>

                            <button type="submit" class="action-button" id="submit-order" disabled>Finalizar Pedido</button>
                        </form>
                    </div>
                </div>
                 <div id="order-success-message" style="display: none;">
                    <h3>Obrigado pelo seu pedido!</h3>
                    <p>Ele já foi enviado para a nossa cozinha e em breve chegará até você.</p>
                </div>
            </aside>
        </div>
    </div>

    <div id="selection-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div id="modal-header" class="modal-header"></div>
            <div id="modal-body" class="modal-body"></div>
            <div class="modal-footer">
                <div id="modal-feedback" class="modal-feedback"></div>
                <button id="add-to-cart-btn" class="action-button">Adicionar ao Carrinho</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'http://localhost:10000';
            const socket = io(API_BASE_URL);

            const dom = {
                productsGrid: document.getElementById('products-grid'),
                combosGrid: document.getElementById('combos-grid'),
                cartItemsContainer: document.getElementById('cart-items'),
                subtotalEl: document.getElementById('subtotal'),
                deliveryFeeEl: document.getElementById('delivery-fee'),
                grandTotalEl: document.getElementById('grand-total'),
                orderForm: document.getElementById('order-form'),
                submitOrderBtn: document.getElementById('submit-order'),
                cartWrapper: document.getElementById('cart-wrapper'),
                successMessage: document.getElementById('order-success-message'),
                storeStatusBanner: document.getElementById('store-status-banner'),
                modal: document.getElementById('selection-modal'),
                modalHeader: document.getElementById('modal-header'),
                modalBody: document.getElementById('modal-body'),
                modalFeedback: document.getElementById('modal-feedback'),
                addToCartBtn: document.getElementById('add-to-cart-btn'),
                clearCartBtn: document.getElementById('clear-cart-btn'),
                addressGroup: document.getElementById('address-group'),
                clientAddressInput: document.getElementById('client-address'),
                deliveryFeeRow: document.getElementById('delivery-fee-row'),
                storeNameHeader: document.getElementById('store-name-header'),
                themeSwitcher: document.getElementById('theme-switcher'),
            };

            let cart = [];
            let allItems = []; 
            let allProductsFlat = [];
            let productParentMap = {};
            let storeSettings = {};
            let liveStockState = {};

            const apiFetch = async (endpoint, options = {}) => {
                options.headers = { ...options.headers, 'Content-Type': 'application/json' };
                const response = await fetch(`${API_BASE_URL}/api${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `Erro HTTP: ${response.status}` }));
                    throw new Error(errorData.error);
                }
                return response.status === 204 ? null : response.json();
            };

            const applyTheme = (theme) => {
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('pamonharia-theme', theme);
            };

            const getAvailableStock = (item) => {
                if (!item) return 0;

                const parentId = productParentMap[item.id];
                if (parentId) {
                    const parent = allProductsFlat.find(p => p.id === parentId);
                    if (parent && parent.stock_sync_enabled && parent.stock_enabled) {
                        return liveStockState[parent.id] || 0;
                    }
                }

                if (item.stock_enabled) {
                    return liveStockState[item.id] || 0;
                }
                
                return Infinity;
            };

            const isItemEffectivelyOutOfStock = (item) => {
                if (!item) return true; 

                if (item.children && item.children.length > 0 && !item.sell_parent_product) {
                    return item.children.every(child => {
                        const childData = allProductsFlat.find(p => p.id === child.id);
                        return isItemEffectivelyOutOfStock(childData);
                    });
                }
                
                return getAvailableStock(item) <= 0;
            };

            const isComboEffectivelyOutOfStock = (combo) => {
                if (!combo || !combo.products) return true;

                const totalAvailableStock = combo.products.reduce((sum, product) => {
                    const fullProductData = allProductsFlat.find(p => p.id === product.id);
                    return sum + getAvailableStock(fullProductData);
                }, 0);
                
                return totalAvailableStock < combo.total_items_limit;
            };

            const renderItems = () => {
                dom.productsGrid.innerHTML = '';
                dom.combosGrid.innerHTML = '';
                const activeProducts = allItems.filter(item => !item.is_combo && item.is_main_product);
                const activeCombos = allItems.filter(item => item.is_combo);
                document.getElementById('products-section').style.display = activeProducts.length > 0 ? 'block' : 'none';
                document.getElementById('combos-section').style.display = activeCombos.length > 0 ? 'block' : 'none';
                document.getElementById('section-divider').style.display = activeProducts.length > 0 && activeCombos.length > 0 ? 'block' : 'none';

                allItems.forEach(item => {
                    if (!item.status) return;
                    const grid = item.is_combo ? dom.combosGrid : dom.productsGrid;
                    if (!grid || (!item.is_main_product && !item.is_combo)) return;
                    
                    let priceText;
                    if (item.is_combo) {
                        priceText = `A partir de R$ ${parseFloat(item.price).toFixed(2).replace('.',',')}`;
                    } else if (item.children && item.children.length > 0 && !item.sell_parent_product) {
                        const availableChildren = item.children.filter(c => !isItemEffectivelyOutOfStock(allProductsFlat.find(p => p.id === c.id)));
                        if (availableChildren.length > 0) {
                            const minPrice = Math.min(...availableChildren.map(c => c.price));
                            priceText = `A partir de R$ ${parseFloat(minPrice).toFixed(2).replace('.',',')}`;
                        } else {
                            priceText = 'Opções esgotadas';
                        }
                    } else {
                        priceText = `R$ ${parseFloat(item.price).toFixed(2).replace('.',',')}`;
                    }
                    
                    const hasOptions = (item.children && item.children.length > 0) || (item.is_combo);
                    const isOutOfStock = item.is_combo ? isComboEffectivelyOutOfStock(item) : isItemEffectivelyOutOfStock(item);
                    
                    const onClickAction = item.is_combo 
                        ? `openComboModal(${item.id})` 
                        : (hasOptions
                            ? `openProductWithOptionsModal(${item.id})` 
                            : `addToCartSimple(${item.id})`);

                    grid.innerHTML += `
                        <div class="item-card ${isOutOfStock ? 'out-of-stock' : ''}" data-id="${item.id}">
                            <div class="stock-overlay">${isOutOfStock ? 'Esgotado' : ''}</div>
                            <img src="${item.image_url || 'https://placehold.co/400x250/f59e0b/FFF?text=Pamonha'}" alt="${item.name}" class="item-image">
                            <div class="item-info">
                                <h3>${item.name}</h3>
                                <p class="description">${item.description || ''}</p>
                                <div class="item-price">${priceText}</div>
                                <button class="action-button" onclick="${onClickAction}" ${!storeSettings.is_open || isOutOfStock ? 'disabled' : ''}>
                                    ${hasOptions ? 'Montar' : 'Adicionar'}
                                </button>
                            </div>
                        </div>`;
                });
            };

            const renderCart = () => {
                dom.clearCartBtn.style.display = cart.length > 0 ? 'inline-block' : 'none';
                if (cart.length === 0) {
                    dom.cartItemsContainer.innerHTML = '<p id="empty-cart-msg">Seu carrinho está vazio.</p>';
                    dom.submitOrderBtn.disabled = true;
                } else {
                    dom.cartItemsContainer.innerHTML = '';
                    cart.forEach((item, index) => {
                        let itemDetails = '';
                        if (item.selected_items && item.selected_items.length > 0) {
                            itemDetails = `<small>${item.selected_items.map(si => si.name).join(', ')}</small>`;
                        }
                        dom.cartItemsContainer.innerHTML += `<div class="cart-item" data-cart-item-id="${item.cart_id}"><img src="${item.image_url || 'https://placehold.co/60x60/f59e0b/FFF?text=Item'}" alt="${item.name}" class="cart-item-image"><div class="cart-item-info"><strong>${item.quantity}x ${item.name}</strong>${itemDetails}</div><div class="cart-item-controls"><button onclick="removeFromCart(${index})">Remover</button><span>R$ ${(item.price * item.quantity).toFixed(2).replace('.',',')}</span></div></div>`;
                    });
                    dom.submitOrderBtn.disabled = !storeSettings.is_open;
                }
                calculateTotals();
            };

            const calculateTotals = () => {
                const subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
                const isDelivery = document.querySelector('input[name="delivery-type"]:checked').value === 'delivery';
                const deliveryFee = isDelivery ? parseFloat(storeSettings.delivery_fee || 0) : 0;
                dom.deliveryFeeRow.style.display = isDelivery ? 'flex' : 'none';
                const grandTotal = subtotal + deliveryFee;
                dom.subtotalEl.textContent = `R$ ${subtotal.toFixed(2).replace('.',',')}`;
                dom.deliveryFeeEl.textContent = `R$ ${deliveryFee.toFixed(2).replace('.',',')}`;
                dom.grandTotalEl.textContent = `R$ ${grandTotal.toFixed(2).replace('.',',')}`;
            };
            
            const updateStoreStatus = () => {
                const now = new Date();
                const dayOfWeek = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'][now.getDay()];
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                let isOpen = false;
                if (storeSettings.is_open_manual_override !== null) {
                    isOpen = storeSettings.is_open_manual_override;
                } else {
                    const schedule = storeSettings.operating_hours?.[dayOfWeek];
                    if (schedule && schedule.enabled) {
                        isOpen = currentTime >= schedule.open && currentTime <= schedule.close;
                    }
                }
                storeSettings.is_open = isOpen;
                dom.storeStatusBanner.style.display = 'block';
                if (isOpen) {
                    dom.storeStatusBanner.textContent = 'Loja Aberta! Faça seu pedido.';
                    dom.storeStatusBanner.className = 'open';
                } else {
                    dom.storeStatusBanner.textContent = 'Loja Fechada. Não estamos a aceitar pedidos no momento.';
                    dom.storeStatusBanner.className = 'closed';
                }
                if(storeSettings.store_name) dom.storeNameHeader.textContent = storeSettings.store_name;
            };

            const handleQuantityChange = (target, state, validator, item, options = {}) => {
                const itemId = parseInt(target.dataset.itemId);
                const isIncrement = target.textContent === '+';
                
                let currentTotalQuantityInModalForSyncGroup = 0;
                let stockHoldingProduct = item;
                
                const parentId = productParentMap[item.id];
                if (parentId) {
                    const parent = allProductsFlat.find(p => p.id === parentId);
                    if (parent && parent.stock_sync_enabled) {
                        stockHoldingProduct = parent;
                        currentTotalQuantityInModalForSyncGroup = Object.entries(state)
                            .filter(([key, _]) => productParentMap[key] === parentId)
                            .reduce((sum, [_, qty]) => sum + qty, 0);
                    }
                }
                
                console.log(`[Cardapio-Modal] Tentativa de alterar quantidade para item ID: ${itemId} (${item.name}). Ação: ${isIncrement ? 'Aumentar' : 'Diminuir'}.`);
                
                if (isIncrement && options.isComplement && options.oneToOneRuleActive) {
                    const parentQty = options.getParentQty();
                    const totalComplements = options.getTotalComplementsQty();
                    if (totalComplements >= parentQty) {
                        const feedbackMsg = `Limite de complementos atingido (${parentQty}).`;
                        console.warn(`[Cardapio-Modal] ⚠️ Validação falhou: ${feedbackMsg}`);
                        dom.modalFeedback.textContent = feedbackMsg;
                        setTimeout(() => dom.modalFeedback.textContent = '', 3000);
                        return;
                    }
                }

                if (isIncrement) {
                    const availableStock = getAvailableStock(item);
                    const currentQuantity = stockHoldingProduct.id === item.id ? (state[itemId] || 0) : currentTotalQuantityInModalForSyncGroup;

                    console.log(`[Cardapio-Modal] Verificando estoque para ${stockHoldingProduct.name}. Habilitado: ${stockHoldingProduct.stock_enabled}. Em estoque: ${availableStock}. Quantidade no modal: ${currentQuantity}.`);

                    if (availableStock !== Infinity && currentQuantity >= availableStock) {
                         const feedbackMsg = `Limite de estoque para "${stockHoldingProduct.name}" atingido: ${availableStock} unid.`;
                        console.warn(`[Cardapio-Modal] ⚠️ Validação falhou: ${feedbackMsg}`);
                        dom.modalFeedback.textContent = feedbackMsg;
                        setTimeout(() => dom.modalFeedback.textContent = '', 3000);
                        return;
                    }
                    
                    state[itemId] = (state[itemId] || 0) + 1;
                } else {
                    state[itemId] = Math.max(0, (state[itemId] || 0) - 1);
                }
                
                console.log(`[Cardapio-Modal] Nova quantidade para item ${itemId} é ${state[itemId]}.`);
                document.getElementById(`quantity-${itemId}`).textContent = state[itemId];
                if (validator) validator();
            };

            const addToCartAndReserve = (itemData, itemsToReserve) => {
                console.log('[Cardapio] 📦 Adicionando ao carrinho e enviando "reserve_stock" para o servidor com:', itemsToReserve);
                socket.emit('reserve_stock', itemsToReserve);
                
                socket.once('reservation_success', () => {
                    console.log('[Cardapio] ✅ Sucesso na reserva recebido do servidor.');
                    cart.push({ ...itemData, cart_id: `cart_${Date.now()}` });
                    renderCart();
                    dom.modal.style.display = 'none';
                });

                socket.once('reservation_failure', ({ message }) => {
                    console.error(`[Cardapio] ❌ Falha na reserva recebida do servidor: ${message}`);
                    dom.modalFeedback.textContent = `Erro: ${message}`;
                });
            };

            window.addToCartSimple = (itemId) => {
                const item = allProductsFlat.find(p => p.id === itemId);
                if (!item) return;

                if (isItemEffectivelyOutOfStock(item)) {
                    alert('Desculpe, este item acabou de esgotar.');
                    return;
                }
                
                const itemsToReserve = [{ id: item.id, quantity: 1 }];
                const itemData = {
                    original_id: item.id, name: item.name, price: item.price, image_url: item.image_url, quantity: 1
                };
                addToCartAndReserve(itemData, itemsToReserve);
            };
            
            window.removeFromCart = (cartIndex) => {
                const itemToRemove = cart[cartIndex];
                if (!itemToRemove) return;

                let itemsToRelease = [];

                if (itemToRemove.is_combo || itemToRemove.has_addons) {
                    const parentData = allProductsFlat.find(p => p.id === itemToRemove.original_id);
                    const isStockSynced = parentData && parentData.stock_sync_enabled;

                    if (isStockSynced) {
                        itemsToRelease.push({ id: itemToRemove.original_id, quantity: itemToRemove.quantity });
                    } else {
                        itemToRemove.selected_items.forEach(si => {
                            itemsToRelease.push({ id: si.id, quantity: si.quantity });
                        });
                        if(itemToRemove.has_addons && itemToRemove.sell_parent_product) {
                            itemsToRelease.push({ id: itemToRemove.original_id, quantity: itemToRemove.quantity });
                        }
                    }
                } else {
                    itemsToRelease.push({ id: itemToRemove.original_id, quantity: itemToRemove.quantity });
                }
                
                socket.emit('release_stock', itemsToRelease.filter(i => i && i.id));
                cart.splice(cartIndex, 1);
                renderCart();
            };

            dom.clearCartBtn.addEventListener('click', () => {
                if (cart.length === 0) return;
                
                const allItemsToRelease = cart.flatMap(item => {
                    if (item.is_combo || item.has_addons) {
                         const parentData = allProductsFlat.find(p => p.id === item.original_id);
                         const isStockSynced = parentData && parentData.stock_sync_enabled;

                         if (isStockSynced) {
                            return [{ id: item.original_id, quantity: item.quantity }];
                         } else {
                             const children = item.selected_items.map(si => ({ id: si.id, quantity: si.quantity }));
                             if(item.has_addons && item.sell_parent_product) {
                                children.push({ id: item.original_id, quantity: item.quantity });
                             }
                             return children;
                         }
                    }
                    return [{ id: item.original_id, quantity: item.quantity }];
                }).filter(i => i && i.id);

                socket.emit('release_stock', allItemsToRelease);
                cart = [];
                renderCart();
            });
            
            const setupModal = (config) => {
                dom.modalHeader.innerHTML = `<h3>${config.title}</h3><p>${config.description}</p>`;
                dom.modalBody.innerHTML = config.body || '';
                dom.modalFeedback.textContent = '';
                dom.addToCartBtn.textContent = 'Adicionar ao Carrinho';
                dom.addToCartBtn.onclick = config.onSave;
                dom.modal.querySelector('.modal-close-btn').onclick = () => dom.modal.style.display = 'none';
                dom.modal.style.display = 'flex';
                if(config.onOpen) config.onOpen();
            };
            
            window.openProductWithOptionsModal = (productId) => {
                const product = allItems.find(item => item.id === productId);
                if (!product) return;
                
                console.log(`[Cardapio] Abrindo modal de opções para o produto: ${product.name} (ID: ${productId}).`);

                let selectedItemsInModal = {};
                let bodyHtml = '';
                
                const initialParentQty = (product.sell_parent_product || !product.children || product.children.length === 0) ? 1 : 0;

                if (product.sell_parent_product) {
                    const isParentOutOfStock = isItemEffectivelyOutOfStock(product);
                    bodyHtml += `<div class="modal-parent-item"><span>${product.name} (Base)</span><div class="quantity-control"><button data-item-id="${product.id}" ${isParentOutOfStock ? 'disabled' : ''}>-</button><span id="quantity-${product.id}">${initialParentQty}</span><button data-item-id="${product.id}" ${isParentOutOfStock ? 'disabled' : ''}>+</button></div></div>`;
                    if (initialParentQty > 0) selectedItemsInModal[product.id] = initialParentQty;
                }

                if (product.children && product.children.length > 0) {
                    bodyHtml += `<h4>${product.sell_parent_product ? 'Adicione complementos:' : 'Escolha os sabores:'}</h4>`;
                    product.children.forEach(option => {
                        const fullOptionData = allProductsFlat.find(p => p.id === option.id);
                        const isOptionOutOfStock = isItemEffectivelyOutOfStock(fullOptionData);
                        bodyHtml += `<div class="modal-item-option ${isOptionOutOfStock ? 'disabled' : ''}"><label>${option.name} (R$ ${parseFloat(option.price).toFixed(2).replace('.',',')})</label><div class="quantity-control"><button data-item-id="${option.id}" data-is-complement="true" ${isOptionOutOfStock ? 'disabled' : ''}>-</button><span id="quantity-${option.id}">0</span><button data-item-id="${option.id}" data-is-complement="true" ${isOptionOutOfStock ? 'disabled' : ''}>+</button></div></div>`;
                    });
                }

                const onSave = () => {
                    let finalPrice = 0;
                    let finalQuantity = selectedItemsInModal[product.id] || 1;
                    
                    if (!product.sell_parent_product) {
                        finalQuantity = Object.entries(selectedItemsInModal)
                            .filter(([id, _]) => id != product.id)
                            .reduce((sum, [_, qty]) => sum + qty, 0);
                    }

                    let selected_items_details = [];
                    let itemsToReserve = [];

                    const parentData = allProductsFlat.find(p => p.id === product.id);
                    const isStockSynced = parentData && parentData.stock_sync_enabled;

                    if (isStockSynced) {
                        const totalQuantityToReserve = Object.values(selectedItemsInModal).reduce((sum, qty) => sum + qty, 0);
                        if (totalQuantityToReserve > 0) {
                            itemsToReserve.push({ id: product.id, quantity: totalQuantityToReserve });
                        }
                    }

                    for (const [id, quantity] of Object.entries(selectedItemsInModal)) {
                        if (quantity > 0) {
                            const selectedItem = allProductsFlat.find(i => i.id == id);
                            if (!selectedItem) continue;

                            if (!isStockSynced) {
                                itemsToReserve.push({ id: selectedItem.id, quantity: quantity });
                            }
                             
                            if (product.sell_parent_product) {
                                if (selectedItem.id === product.id) finalPrice += parseFloat(selectedItem.price) * quantity;
                            }
                            if (selectedItem.id !== product.id) {
                                finalPrice += parseFloat(selectedItem.price) * quantity;
                                selected_items_details.push({ id: selectedItem.id, name: `${quantity}x ${selectedItem.name}`, quantity: quantity });
                            }
                        }
                    }
                     
                    const finalItemPrice = finalQuantity > 0 ? finalPrice / finalQuantity : 0;
                    
                    const itemData = {
                        original_id: product.id, name: product.name, price: finalItemPrice, quantity: finalQuantity, has_addons: true, sell_parent_product: product.sell_parent_product, selected_items: selected_items_details, image_url: product.image_url
                    };
                    addToCartAndReserve(itemData, itemsToReserve);
                };
                
                const validator = () => {
                    const totalSelected = Object.values(selectedItemsInModal).reduce((sum, qty) => sum + qty, 0);
                    let isValid = totalSelected > 0;
                    let totalQuantityForButton = 0;

                    if (product.force_one_to_one_complement) {
                        const parentQty = selectedItemsInModal[product.id] || 0;
                        totalQuantityForButton = parentQty;
                        const totalComplementsQty = Object.entries(selectedItemsInModal)
                            .filter(([id, _]) => id != product.id)
                            .reduce((sum, [_, qty]) => sum + qty, 0);
                        
                        const diff = parentQty - totalComplementsQty;
                        if (diff > 0) dom.modalFeedback.textContent = `Selecione mais ${diff} complemento(s).`;
                        else if (diff < 0) dom.modalFeedback.textContent = `Remova ${-diff} complemento(s).`;
                        else dom.modalFeedback.textContent = '';
                        
                        isValid = (parentQty === totalComplementsQty) && parentQty > 0;
                    } else if (!product.sell_parent_product) {
                        totalQuantityForButton = Object.entries(selectedItemsInModal)
                            .filter(([id, _]) => id != product.id)
                            .reduce((sum, [_, qty]) => sum + qty, 0);
                        isValid = totalQuantityForButton > 0;
                    }
                     else {
                        totalQuantityForButton = selectedItemsInModal[product.id] || 0;
                        isValid = totalQuantityForButton > 0;
                        dom.modalFeedback.textContent = '';
                    }

                    if (isValid && totalQuantityForButton > 0) {
                        dom.addToCartBtn.textContent = `Adicionar (${totalQuantityForButton}) ao Carrinho`;
                    } else {
                        dom.addToCartBtn.textContent = 'Adicionar ao Carrinho';
                    }

                    dom.addToCartBtn.disabled = !isValid;
                };

                setupModal({ 
                    title: `Adicionar ${product.name}`, 
                    description: product.force_one_to_one_complement ? 'Escolha a mesma quantidade de complementos que a do item principal.' : 'Selecione as opções.', 
                    body: bodyHtml, 
                    onSave, 
                    onOpen: validator 
                });

                dom.modalBody.querySelectorAll('.quantity-control button[data-item-id]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const optionId = e.target.dataset.itemId;
                        const option = allProductsFlat.find(i => i.id == optionId);
                        if (option) {
                            const changeOptions = {
                                isComplement: e.target.dataset.isComplement === 'true',
                                oneToOneRuleActive: product.force_one_to_one_complement,
                                getParentQty: () => selectedItemsInModal[product.id] || 0,
                                getTotalComplementsQty: () => Object.entries(selectedItemsInModal)
                                    .filter(([id, _]) => id != product.id)
                                    .reduce((sum, [_, qty]) => sum + qty, 0)
                            };
                            handleQuantityChange(e.target, selectedItemsInModal, validator, option, changeOptions);
                        }
                    });
                });
            };

            window.openComboModal = (comboId) => {
                const combo = allItems.find(item => item.id === comboId);
                if (!combo) return;

                console.log(`[Cardapio] Abrindo modal para o combo: ${combo.name} (ID: ${comboId}).`);

                let selectedQuantities = {};
                let comboBodyHtml = '';
                combo.products.forEach(option => {
                    const fullOptionData = allProductsFlat.find(p => p.id === option.id);
                    const isOptionOutOfStock = isItemEffectivelyOutOfStock(fullOptionData);
                    const priceModifierText = option.price_modifier > 0 ? `+ R$ ${parseFloat(option.price_modifier).toFixed(2).replace('.',',')}` : '';
                    comboBodyHtml += `<div class="modal-item-option ${isOptionOutOfStock ? 'disabled' : ''}"><label>${option.name} ${isOptionOutOfStock ? '<small>(Esgotado)</small>' : ''}</label><span class="price-modifier">${priceModifierText}</span><div class="quantity-control"><button data-item-id="${option.id}" ${isOptionOutOfStock ? 'disabled' : ''}>-</button><span id="quantity-${option.id}">0</span><button data-item-id="${option.id}" ${isOptionOutOfStock ? 'disabled' : ''}>+</button></div></div>`;
                });

                const validator = () => {
                    const totalSelected = Object.values(selectedQuantities).reduce((sum, qty) => sum + qty, 0);
                    const totalLimit = combo.total_items_limit;
                    dom.addToCartBtn.disabled = totalSelected !== totalLimit;
                    dom.modalFeedback.textContent = '';
                    dom.addToCartBtn.textContent = `Adicionar (${totalSelected}/${totalLimit}) ao Carrinho`;
                };

                const onSave = () => {
                    let finalPrice = parseFloat(combo.price);
                    let selected_items = [];
                    let itemsToReserve = [];
                    for (const [id, quantity] of Object.entries(selectedQuantities)) {
                        if (quantity > 0) {
                            const product = allProductsFlat.find(p => p.id == id);
                            const comboProductInfo = combo.products.find(p => p.id == id);
                            finalPrice += parseFloat(comboProductInfo.price_modifier || 0) * quantity;
                            selected_items.push({ id: product.id, name: `${quantity}x ${product.name}`, quantity: quantity });
                            itemsToReserve.push({ id: product.id, quantity });
                        }
                    }
                    const itemData = {
                        original_id: combo.id, name: combo.name, price: finalPrice, is_combo: true, quantity: 1, selected_items, image_url: combo.image_url
                    };
                    addToCartAndReserve(itemData, itemsToReserve);
                };
                
                setupModal({ title: `Montar ${combo.name}`, description: `Selecione exatamente ${combo.total_items_limit} itens.`, body: comboBodyHtml, onSave, onOpen: validator });
                
                dom.modalBody.querySelectorAll('.quantity-control button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const totalLimit = combo.total_items_limit;
                        const currentTotal = Object.values(selectedQuantities).reduce((s, q) => s + q, 0);
                        if (e.target.textContent === '+' && currentTotal >= totalLimit) {
                             dom.modalFeedback.textContent = `Você já selecionou o limite de ${totalLimit} itens.`;
                             setTimeout(() => dom.modalFeedback.textContent = '', 2500);
                             return;
                        }
                        const optionId = e.target.dataset.itemId;
                        const option = allProductsFlat.find(p => p.id == optionId);
                        if(option) {
                            handleQuantityChange(e.target, selectedQuantities, validator, option);
                        }
                    });
                });
            };
            
            const fetchAndRenderAll = async () => {
                try {
                    console.log('[Cardapio] Buscando todos os dados (produtos, combos, settings)...');
                    const [productsResponse, combosResponse, settingsResponse] = await Promise.all([
                        apiFetch('/public/products'),
                        apiFetch('/public/combos'),
                        apiFetch('/public/settings')
                    ]);
                    
                    storeSettings = settingsResponse;
                    
                    allProductsFlat = [];
                    productParentMap = {};
                    const recursiveFlattenAndMap = (products, parent = null) => {
                        if (!products) return;
                        products.forEach(p => {
                            allProductsFlat.push(p);
                            if (parent) {
                                productParentMap[p.id] = parent.id;
                            }
                            if (p.children && p.children.length > 0) {
                                recursiveFlattenAndMap(p.children, p);
                            }
                        });
                    };
                    recursiveFlattenAndMap(productsResponse);
                    
                    combosResponse.forEach(c => {
                        if (c.products) {
                            c.products = c.products.map(p => allProductsFlat.find(i => i.id === p.id) || p);
                        }
                    });
                    
                    allItems = [...combosResponse.map(c => ({...c, is_combo: true})), ...productsResponse];

                    console.log('[Cardapio] ✅ Dados carregados e processados.');
                    updateStoreStatus();
                    renderItems();
                    renderCart();
                } catch (error) {
                    console.error("[Cardapio] ❌ Falha ao buscar dados:", error);
                    document.body.innerHTML = '<h1>Erro ao carregar o cardápio. Tente novamente mais tarde.</h1>';
                }
            };
            
            socket.on('connect', () => console.log('[Cardapio] ✅ Socket.IO conectado ao servidor.'));

            socket.on('stock_update', (inventory) => {
                console.log('[Cardapio] 🔄 Recebido evento "stock_update". Novo estado do estoque:', inventory);
                liveStockState = inventory;
                renderItems();
            });

            socket.on('data_updated', fetchAndRenderAll);

            dom.themeSwitcher.addEventListener('click', () => {
                const currentTheme = document.body.getAttribute('data-theme');
                applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });

            dom.orderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                dom.submitOrderBtn.disabled = true;
                dom.submitOrderBtn.textContent = 'A enviar...';
                const deliveryType = document.querySelector('input[name="delivery-type"]:checked').value;
                const address = deliveryType === 'delivery' ? dom.clientAddressInput.value : 'Retirada no local';
                
                const itemsForBackend = cart.map(item => ({
                    id: item.original_id, name: item.name, price: item.price, quantity: item.quantity, is_combo: !!item.is_combo, selected_items: item.selected_items || []
                }));

                const orderData = {
                    client_name: document.getElementById('client-name').value,
                    client_phone: document.getElementById('client-phone').value,
                    client_address: address,
                    items: itemsForBackend,
                    total_price: parseFloat(dom.grandTotalEl.textContent.replace('R$ ', '').replace(',', '.'))
                };
                
                try {
                    await apiFetch('/public/orders', { method: 'POST', body: JSON.stringify(orderData) });
                    dom.cartWrapper.style.display = 'none';
                    dom.successMessage.style.display = 'block';
                    cart = [];
                } catch (error) {
                    alert(`Desculpe, não foi possível enviar seu pedido. Erro: ${error.message}`);
                    dom.submitOrderBtn.disabled = false;
                    dom.submitOrderBtn.textContent = 'Finalizar Pedido';
                }
            });

            document.querySelectorAll('input[name="delivery-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isDelivery = e.target.value === 'delivery';
                    dom.addressGroup.style.display = isDelivery ? 'block' : 'none';
                    dom.clientAddressInput.required = isDelivery;
                    calculateTotals();
                });
            });

            const savedTheme = localStorage.getItem('pamonharia-theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
            
            fetchAndRenderAll();
        });
    </script>
</body>
</html>