<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Pamonharia 2.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/dashboard/style.css">
</head>
<body>
    <script>
        const token = localStorage.getItem('authToken');
        if (!token) { window.location.href = '/'; }
    </script>

    <div class="main-container">
        <aside class="sidebar">
            <h2>Pamonharia 2.0</h2>
            <nav>
                <ul>
                    <li><a id="nav-pedidos" href="#">Pedidos</a></li>
                    <li><a id="nav-produtos" href="#">Produtos</a></li>
                    <li><a id="nav-complementos" href="#">Complementos</a></li>
                    <li><a id="nav-combos" href="#">Combos</a></li>
                    <li><a id="nav-configuracoes" href="#">Configurações</a></li>
                </ul>
            </nav>
            <button id="logout-button">Sair</button>
        </aside>

        <main class="content">
            <header class="header">
                <h1 id="page-title">Painel de Pedidos</h1>
            </header>
            <div id="dashboard-content">
                </div>
        </main>
    </div>

    <script>
        const pageTitle = document.getElementById('page-title');
        const dashboardContent = document.getElementById('dashboard-content');

        function renderPedidosPage() { pageTitle.textContent = 'Painel de Pedidos'; dashboardContent.innerHTML = `<p>A interface de gestão de pedidos aparecerá aqui.</p>`; }
        function renderProdutosPage() { pageTitle.textContent = 'Gestão de Produtos'; dashboardContent.innerHTML = `<p>A interface de CRUD de produtos aparecerá aqui.</p>`; }
        function renderComplementosPage() { pageTitle.textContent = 'Gestão de Complementos'; dashboardContent.innerHTML = `<p>A interface de CRUD de complementos aparecerá aqui.</p>`; }
        function renderCombosPage() { pageTitle.textContent = 'Gestão de Combos'; dashboardContent.innerHTML = `<p>A interface de CRUD de combos aparecerá aqui.</p>`; }
        
        function renderSettingsPage() {
            pageTitle.textContent = 'Configurações da Loja';
            dashboardContent.innerHTML = `
                <form id="settings-form">
                    <div class="settings-card">
                        <div class="card-header">
                            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 17.58A5 5 0 0 0 15 12.58A5 5 0 0 0 10 17.58a5 5 0 0 0 1.95 3.9A5 5 0 0 0 8.58 22a5 5 0 0 0 4.27-2.05A5 5 0 0 0 17.42 22a5 5 0 0 0 3.9-1.95A5 5 0 0 0 20 17.58Z"/><path d="M12 2.58A5 5 0 0 0 7 7.58A5 5 0 0 0 12 12.58a5 5 0 0 0 3.05-1.07A5 5 0 0 0 18.58 5a5 5 0 0 0-4.27-2.95A5 5 0 0 0 12 2.58Z"/></svg></span>
                            <h3>Status da Loja</h3>
                        </div>
                        <div id="status-buttons" class="status-buttons">
                            <button type="button" data-status="true">Forçar Aberta</button>
                            <button type="button" data-status="false">Forçar Fechada</button>
                            <button type="button" data-status="null">Seguir Horário</button>
                        </div>
                    </div>

                    <div class="settings-card">
                         <div class="card-header">
                            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 9v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9"/><path d="m20 9-8-5-8 5"/><path d="M9 22V12h6v10"/></svg></span>
                            <h3>Informações Gerais</h3>
                        </div>
                        <div class="info-grid">
                            <div>
                                <label for="store_name">Nome da Loja</label>
                                <input type="text" id="store_name" name="store_name">
                            </div>
                            <div>
                                <label for="address">Endereço</label>
                                <input type="text" id="address" name="address">
                            </div>
                            <div style="grid-column: span 2;">
                                <label for="location_link">Link do Google Maps</label>
                                <input type="text" id="location_link" name="location_link">
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                         <div class="card-header">
                            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></span>
                            <h3>Financeiro</h3>
                        </div>
                        <div>
                            <label for="delivery_fee">Taxa de Entrega (R$)</label>
                            <input type="number" id="delivery_fee" name="delivery_fee" step="0.50">
                        </div>
                        </div>

                    <div class="settings-card">
                        <div class="card-header">
                           <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></span>
                           <h3>Horários de Funcionamento</h3>
                        </div>
                        <div class="operating-hours-grid" id="hours-grid">
                            <div class="grid-header">Dia</div>
                            <div class="grid-header">Abre às</div>
                            <div class="grid-header">Fecha às</div>
                            <div class="grid-header">Aberto?</div>
                        </div>
                    </div>
                    
                    <div class="save-button-container">
                        <span id="save-feedback"></span>
                        <button type="submit" class="save-button">Salvar Alterações</button>
                    </div>
                </form>
            `;
            fetchAndPopulateSettings();
        }
        
        async function fetchAndPopulateSettings() {
            try {
                const response = await fetch('/settings', { headers: { 'Authorization': 'Bearer ' + token } });
                const settings = await response.json();

                document.getElementById('store_name').value = settings.store_name;
                document.getElementById('address').value = settings.address;
                document.getElementById('location_link').value = settings.location_link;
                document.getElementById('delivery_fee').value = parseFloat(settings.delivery_fee).toFixed(2);
                
                document.querySelectorAll('#status-buttons button').forEach(button => {
                    button.classList.remove('selected');
                    if (String(button.dataset.status) === String(settings.is_open_manual_override)) button.classList.add('selected');
                });

                const hoursGrid = document.getElementById('hours-grid');
                const days = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado', 'domingo'];
                days.forEach(day => {
                    const daySettings = settings.operating_hours[day];
                    hoursGrid.innerHTML += `
                        <div class="day">${day}</div>
                        <input type="time" id="open-${day}" value="${daySettings.open}">
                        <input type="time" id="close-${day}" value="${daySettings.close}">
                        <label class="toggle-switch">
                            <input type="checkbox" id="enabled-${day}" ${daySettings.enabled ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    `;
                });
                addSettingsListeners();
            } catch (error) { console.error("Falha ao buscar configurações:", error); }
        }
        
        function addSettingsListeners() {
            // A lógica de listeners para salvar os dados permanece a mesma
            const settingsForm = document.getElementById('settings-form');
            if (!settingsForm) return;
            
            const statusButtons = document.getElementById('status-buttons');
            statusButtons.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    statusButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            });
            
            settingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const feedback = document.getElementById('save-feedback');
                feedback.textContent = 'Salvando...';

                const operating_hours = {};
                ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado', 'domingo'].forEach(day => {
                    operating_hours[day] = {
                        open: document.getElementById(`open-${day}`).value,
                        close: document.getElementById(`close-${day}`).value,
                        enabled: document.getElementById(`enabled-${day}`).checked
                    };
                });
                
                let overrideStatus = document.querySelector('#status-buttons button.selected')?.dataset.status;
                if (overrideStatus === 'null') overrideStatus = null;
                else overrideStatus = overrideStatus === 'true';
                
                const dataToSend = {
                    store_name: document.getElementById('store_name').value,
                    address: document.getElementById('address').value,
                    location_link: document.getElementById('location_link').value,
                    delivery_fee: document.getElementById('delivery_fee').value,
                    is_open_manual_override: overrideStatus,
                    operating_hours: operating_hours,
                };

                try {
                    const response = await fetch('/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify(dataToSend)
                    });
                    if (!response.ok) throw new Error('Falha ao salvar');
                    feedback.textContent = 'Salvo com sucesso!';
                    setTimeout(() => feedback.textContent = '', 3000);
                } catch (error) { feedback.textContent = 'Erro ao salvar.'; }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = { 
                pedidos: document.getElementById('nav-pedidos'), 
                produtos: document.getElementById('nav-produtos'), 
                complementos: document.getElementById('nav-complementos'),
                combos: document.getElementById('nav-combos'),
                configuracoes: document.getElementById('nav-configuracoes') 
            };
            
            function handleNavigation(e) {
                e.preventDefault();
                Object.values(navLinks).forEach(link => link.classList.remove('active'));
                const link = e.currentTarget;
                link.classList.add('active');
                const page = link.id.split('-')[1];
                if (page === 'pedidos') renderPedidosPage();
                if (page === 'produtos') renderProdutosPage();
                if (page === 'complementos') renderComplementosPage();
                if (page === 'combos') renderCombosPage();
                if (page === 'configuracoes') renderSettingsPage();
            }
            
            Object.values(navLinks).forEach(link => link.addEventListener('click', handleNavigation));
            
            renderPedidosPage();
            navLinks.pedidos.classList.add('active');

            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.removeItem('authToken');
                window.location.href = '/';
            });
        });
    </script>
</body>
</html>